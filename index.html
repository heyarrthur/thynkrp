<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rota Motos — Estoque</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- jsPDF + AutoTable (PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ====== Paleta e base ====== */
    :root{
      --ink:#0f172a;
      --muted:#6b7280;
      --border:#e6e8ef;
      --accent:#ffc107;       /* amarelo */
      --accent-2:#ffb300;
      --bg:#ffffff;
      --bg-2:#f6f8fb;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --sidebar-w:280px;
      --sidebar-w-collapsed:84px;
  --side-w:260px; --side-collapsed:74px; --radius:12px;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg-2);
      color:var(--ink);
      display:flex;
      transition: margin-left .18s ease;
    }

/* ===== Sidebar fixa (BRANCA) ===== */
.sidebar{
  position:fixed; inset:0 auto 0 0; width:var(--side-w);
  background:var(--sidebar); color:var(--side-txt);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column; z-index:1030;
  transition:width .25s ease, box-shadow .25s ease;
  box-shadow:var(--shadow);
}
.brand{
  display:flex; align-items:center; gap:.6rem;
  padding:16px 16px 14px; font-weight:800; letter-spacing:.2px;
}
.brand .logo{
  width:36px;height:36px;border-radius:10px; background:#111; color:#fff; display:grid; place-items:center;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
}
.nav-scroll{flex:1; overflow:auto; padding:8px 8px 16px}
.side-group{margin:8px 8px 14px}
.side-title{
  font-size:.78rem; text-transform:uppercase; letter-spacing:.08em;
  color:var(--side-dim); padding:10px 10px 6px;
}
.side-divider{height:1px; background:var(--border); margin:6px 10px 8px; border-radius:99px}
.side-sub{font-size:.8rem; color:var(--side-dim); margin:8px 10px 6px}
.side-item{
  display:flex; align-items:center; gap:.7rem; color:var(--side-txt); text-decoration:none;
  padding:10px 12px; border-radius:12px; font-weight:600; position:relative;
  transition:transform .1s ease, background .2s ease, box-shadow .2s ease;
}
.side-item i{font-size:1.05rem}
.side-item:hover{ background:rgba(15,23,42,.05); transform:translateY(-1px) }
.side-item.active{
  background:#fff7ed; box-shadow:inset 0 0 0 2px #fde68a; color:#7c2d12;
}
.side-toggle{
  display:flex; align-items:center; justify-content:center;
  margin:10px; border:1px solid var(--border); border-radius:12px; height:44px;
  background:#fff; color:var(--side-txt); width:calc(100% - 20px);
  box-shadow:var(--shadow); transition:transform .1s ease, box-shadow .2s ease;
}
.side-toggle:hover{ transform:translateY(-1px); box-shadow:var(--shadow-strong); }

/* Colapsar = apenas ícones */
body.collapsed{ padding-left:var(--side-collapsed) }
body.collapsed .sidebar{ width:var(--side-collapsed) }
.hide-on-collapse{ transition:opacity .15s ease }
body.collapsed .hide-on-collapse{ opacity:0; pointer-events:none; width:0 !important; display:none !important }
.show-on-collapse{ display:none }
body.collapsed .show-on-collapse{ display:flex }

/* ===== Topbar ===== */
.topbar{
  position:sticky; top:0; z-index:1010; padding:12px 0; margin-bottom:8px;
  background:linear-gradient(180deg,#ffffffcc,#ffffffaa 60%,#ffffff00);
  backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--border);
  animation:fadeIn .25s ease both;
}

/* ===== Micro animações ===== */
@keyframes fadeInUp{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0} to{opacity:1}}
[data-anim]{animation:fadeInUp .28s ease both}
[data-anim-delay="1"]{animation-delay:.04s}
[data-anim-delay="2"]{animation-delay:.08s}
[data-anim-delay="3"]{animation-delay:.12s}

    /* ====== Conteúdo ====== */
    .content{
      margin-left:var(--sidebar-w);
      width:calc(100% - var(--sidebar-w));
      padding:28px; min-height:100%;
      display:flex; flex-direction:column; gap:18px;
      transition: margin-left .18s ease, width .18s ease;
    }
    .page-head{display:flex; align-items:center; gap:14px; flex-wrap:wrap}
    .pill{padding:.35rem .7rem; border-radius:999px; border:1px dashed var(--accent-2); color:#000; background:#fff7e0; font-weight:700}

    /* ====== Seus estilos (cards/toolbar/tabela) ====== */
    .container{max-width:1180px}
    .card-soft{background:#fff;border:1px solid var(--border);border-radius:12px}
    .metric{display:flex;gap:.8rem;align-items:center;padding:1rem}
    .metric .icon{width:42px;height:42px;border-radius:10px;display:grid;place-items:center;color:#fff}
    .i-items{background:#0ea5e9}.i-low{background:#ef4444}.i-value{background:#059669}
    .metric .label{color:var(--muted);font-size:.9rem}
    .metric .value{font-weight:800;font-size:1.35rem}

    .toolbar{background:#fff;border:1px solid var(--border);border-left:4px solid var(--accent);border-radius:12px;padding:1rem}
    .input-icon{position:relative}
    .input-icon i{position:absolute;left:.65rem;top:50%;transform:translateY(-50%);color:#9aa1ad}
    .input-icon input{padding-left:2.1rem}
    .form-control,.form-select{border-radius:10px;border-color:var(--border)}
    .form-control:focus,.form-select:focus{box-shadow:0 0 0 .25rem rgba(245,158,11,.16);border-color:#fcd34d}
    .btn-ghost{background:#fff;border:1px solid var(--border);font-weight:600}
    .btn-ghost:hover{background:#f9fafb}
    .btn-primary-clean{background:var(--accent);color:#111;border:1px solid #fbbf24;font-weight:700}

    .table thead th{background:#eef2ff;color:#1e1b4b;font-weight:700;position:sticky;top:0;z-index:2;border-bottom:1px solid #e5e7eb}
    .nowrap{white-space:nowrap}
    .empty{color:#6b7280;text-align:center;padding:2rem 0}
    .table tbody tr.is-alert { background:#ffe1e1 !important; }
    .table tbody tr.is-alert td { border-top-color:#f7bdbd !important; }
    .badge-cat{display:inline-block;padding:.22rem .6rem;border-radius:9999px;background:#f1f5f9;border:1px solid #e5e7eb;color:#0f172a;font-weight:700;font-size:.78rem;line-height:1;}
    .table tbody tr.is-alert .badge-cat{background:#ffe8e8;border-color:#f7bdbd;color:#7f1d1d;}

    /* ====== Responsivo / mobile ====== */
    .toggle{display:none}
    @media (max-width: 991.98px){ /* breakpoint Bootstrap lg */
      :root{ --sidebar-w:88vw }
      .content{ margin-left:0; width:100% }
      .toggle{
        position:fixed; top:14px; left:14px; z-index:1100;
        display:inline-flex; gap:8px; align-items:center;
        background:#000; color:#fff; border:none; border-radius:999px; padding:10px 14px; box-shadow:var(--shadow)
      }
      .sidebar{ transform:translateX(-100%); transition: transform .18s ease }
      body.nav-open .sidebar{ transform:none }
    }

    /* ====== Estado recolhido (desktop) ====== */
    body.sidebar-collapsed .sidebar{ width:var(--sidebar-w-collapsed) }
    body.sidebar-collapsed .content{
      margin-left:var(--sidebar-w-collapsed);
      width:calc(100% - var(--sidebar-w-collapsed));
    }
    body.sidebar-collapsed .nav-sub{ opacity:0; pointer-events:none; height:0; margin:0 }
    body.sidebar-collapsed .nav a{ gap:12px; justify-content:center }
    body.sidebar-collapsed .nav a .label,
    body.sidebar-collapsed .brand .text,
    body.sidebar-collapsed .badge{ display:none }
  </style>
</head>
<body>
<!-- SIDEBAR (BRANCA) -->
<aside class="sidebar">
  <div class="brand">
    <span class="logo">RM</span>
    <div class="hide-on-collapse">Rota Motos</div>
  </div>

  <div class="nav-scroll">
    <div class="side-divider"></div>

    <div class="side-group">
      <div class="side-sub">Estoque</div>
      <a class="side-item active" href="index.html"><i class="bi bi-box-seam"></i><span class="hide-on-collapse">Gerenciar</span></a>
    </div>

    <div class="side-group">
      <div class="side-sub">Mecânica</div>
      <a class="side-item" href="oficina.html"><i class="bi bi-wrench-adjustable"></i><span class="hide-on-collapse">Oficina</span></a>
      <a class="side-item" href="oficinaextras.html"><i class="bi bi-gear-wide-connected"></i><span class="hide-on-collapse">Serviços Extras</span></a>
    </div>

    <div class="side-group">
      <div class="side-sub">Financeiro</div>
      <a class="side-item" href="financeiro.html"><i class="bi bi-currency-dollar"></i><span class="hide-on-collapse">Faturamento</span></a>
    </div>

    <div class="side-group">
      <div class="side-sub">Vendas</div>
      <a class="side-item" href="vendas.html"><i class="bi bi-receipt"></i><span class="hide-on-collapse">Vendas</span></a>
    </div>

    <div class="side-group">
      <div class="side-sub">Configurações</div>
      <a class="side-item" href="backup.html"><i class="bi bi-receipt"></i><span class="hide-on-collapse">Backups</span></a>
    </div>
  </div>

  <button id="btnToggleSide" class="side-toggle">
    <i class="bi bi-chevron-left"></i>
    <span class="hide-on-collapse ms-2">Recolher</span>
    <i class="bi bi-chevron-right show-on-collapse"></i>
  </button>
</aside>

  <!-- ====== CONTEÚDO ====== -->
  <main class="content" id="conteudo" tabindex="-1">
    <header class="page-head">
      <h1 class="m-0 h3 fw-bold">Estoque — Gerenciar</h1>
      <span class="pill">Visual atualizado</span>
    </header>

    <div class="container py-2">

      <!-- MÉTRICAS -->
      <div class="row g-3 mb-3">
        <div class="col-md-4"><div class="card-soft metric"><div class="icon i-items"><i class="bi bi-box-seam"></i></div><div><div class="label">Itens cadastrados</div><div id="mItens" class="value">0</div></div></div></div>
        <div class="col-md-4"><div class="card-soft metric"><div class="icon i-low"><i class="bi bi-exclamation-triangle"></i></div><div><div class="label">Itens em alerta</div><div id="mLow" class="value">0</div></div></div></div>
        <div class="col-md-4"><div class="card-soft metric"><div class="icon i-value"><i class="bi bi-cash-coin"></i></div><div><div class="label">Valor em estoque (Preço)</div><div id="mValor" class="value">R$ 0,00</div></div></div></div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar mb-3">
        <div class="row g-3 align-items-end">
          <div class="col-lg-4">
            <label class="form-label mb-1">Buscar</label>
            <div class="input-icon">
              <i class="bi bi-search"></i>
              <input id="search" class="form-control" placeholder="SKU, nome, categoria, local...">
            </div>
          </div>
          <div class="col-lg-3">
            <label class="form-label mb-1">Categoria</label>
            <select id="fCategoria" class="form-select"><option value="">Todas</option></select>
          </div>
          <div class="col-lg-5 d-grid d-lg-flex gap-2 justify-content-lg-end">
            <button id="btnNovo" class="btn btn-primary-clean" data-bs-toggle="modal" data-bs-target="#modalItem">
              <i class="bi bi-plus-lg"></i> Novo item
            </button>

            <!-- Dropdown Ferramentas -->
            <div class="btn-group">
              <button class="btn btn-ghost dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-tools"></i> Ferramentas
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Importar / Exportar</h6></li>
                <li><a class="dropdown-item" id="btnImportXLSX"><i class="bi bi-file-earmark-arrow-up me-2"></i>Importar Excel</a></li>
                <li><a class="dropdown-item" id="btnImportXML"><i class="bi bi-filetype-xml me-2"></i>Importar XML</a></li>
                <li><a class="dropdown-item" id="btnExportXLSX"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar Excel</a></li>
                <li><a class="dropdown-item" id="btnExportXML"><i class="bi bi-filetype-xml me-2"></i>Exportar XML</a></li>
                <li><a class="dropdown-item" id="btnExportPDF"><i class="bi bi-filetype-pdf me-2"></i>Exportar PDF (listados)</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" id="btnMerge"><i class="bi bi-collection me-2"></i>Somar itens repetidos (SKU)</a></li>
                <!-- “Gerar backup (site)” permanece removido -->
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- TABELA -->
      <div class="card-soft p-0">
        <div class="table-responsive" style="max-height:60vh;">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th class="nowrap">SKU</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Local</th>
                <th class="text-end nowrap">Qtd</th>
                <th class="text-end nowrap">Alerta</th>
                <th class="text-end nowrap">Preço</th>
                <th class="text-end nowrap">Custo</th>
                <th class="text-end nowrap">Total (Preço)</th>
                <th class="text-end nowrap">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="empty" class="empty">Nenhum item encontrado.</div>
        </div>
      </div>
    </div>
  </main>

  <!-- MODAL ITEM -->
  <div class="modal fade" id="modalItem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title fw-bold" id="modalTitle">Novo item</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="formItem" class="row g-3" novalidate>
            <div class="col-6"><label class="form-label">SKU</label><input id="iSku" class="form-control" required></div>
            <div class="col-6"><label class="form-label">Nome</label><input id="iNome" class="form-control" required></div>
            <div class="col-6"><label class="form-label">Categoria</label><input id="iCat" class="form-control"></div>
            <div class="col-6"><label class="form-label">Local</label><input id="iLoc" class="form-control"></div>
            <div class="col-4"><label class="form-label">Qtd</label><input id="iQtd" type="number" step="1" min="0" class="form-control" value="0"></div>
            <div class="col-4"><label class="form-label">Alerta</label><input id="iAlerta" type="number" step="1" min="0" class="form-control" value="0"></div>
            <div class="col-4"><label class="form-label">Preço</label><input id="iPreco" type="number" step="0.01" min="0" class="form-control" value="0"></div>
            <div class="col-4"><label class="form-label">Custo</label><input id="iCusto" type="number" step="0.01" min="0" class="form-control" value="0"></div>
            <div class="col-8 d-grid align-items-end"><button id="btnSalvarItem" type="button" class="btn btn-primary-clean">Salvar</button></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- INPUTS de arquivo (ocultos) -->
  <input id="fileXLSX" type="file" accept=".xlsx,.xls" style="display:none">
  <input id="fileXML"  type="file" accept=".xml" style="display:none">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ====== JS DE UI (sidebar mobile + recolher) ====== -->
  <script>
  (function(){
    // Mobile: abre/fecha sidebar
    const btn = document.getElementById('toggleNav');
    if(btn){
      btn.addEventListener('click', () => {
        const open = document.body.classList.toggle('nav-open');
        btn.setAttribute('aria-expanded', String(open));
      });
    }
    // Desktop: recolher/expandir (sem usar localStorage)
    const collapseBtn = document.getElementById('collapseNav');
    if(collapseBtn){
      collapseBtn.addEventListener('click', ()=>{
        document.body.classList.toggle('sidebar-collapsed');
      });
    }
    // Remover qualquer resquício antigo de "backup"
    const nodes = Array.from(document.querySelectorAll('button, a, [data-action], [id], [name]'));
    nodes.forEach(el=>{
      const txt = (el.textContent||'') + ' ' + (el.id||'') + ' ' + (el.getAttribute('data-action')||'');
      if(/backup/i.test(txt)) el.remove();
    });
  })();
  </script>

  <!-- ====== JS DA APLICAÇÃO (mantido; LocalStorage inalterado) ====== -->
  <script>
  (function(){
    /* ===== Helpers ===== */
    const BRL = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
    const $ = id => document.getElementById(id);
    const money = n => BRL.format(+n||0);
    const safe = s => String(s??"");
    const toNum = (v) => {
      if (v === null || v === undefined || v === "") return 0;
      let s = String(v).trim().replace(/[^\d.,-]/g, "");
      const lastComma = s.lastIndexOf(","), lastDot = s.lastIndexOf(".");
      let norm;
      if (lastComma !== -1 && lastDot !== -1) norm = lastComma > lastDot ? s.replace(/\./g,"").replace(",",".") : s.replace(/,/g,"");
      else if (lastComma !== -1) norm = s.replace(",",".");
      else if (lastDot !== -1){ const parts = s.split("."); norm = parts.length>2 ? parts.slice(0,-1).join("") + "." + parts.at(-1) : s; }
      else norm = s;
      const n = Number(norm); return Number.isFinite(n)?n:0;
    };
    const isAlert = (it) => (+it.qtd || 0) <= (+it.alerta || 0);

    /* ===== Storage (mantido) ===== */
    const STOCK_KEYS = ["estoque.ui.v2","estoque.clean.color.v1","estoque.clean.v1","estoque.visualclean.v1","estoque"];
    function loadStock(){
      for(const k of STOCK_KEYS){
        try{ const raw=localStorage.getItem(k); if(raw){ const arr=JSON.parse(raw)||[]; return {key:k, items:Array.isArray(arr)?arr:[]}; } }
        catch(e){}
      }
      return {key:"estoque.ui.v2", items:[]};
    }
    function saveStock(){ localStorage.setItem(estoque.key, JSON.stringify(estoque.items)); }
    function backupStock(){
      try{ localStorage.setItem("estoque.backup.last", JSON.stringify({ ts: Date.now(), key: estoque.key, items: estoque.items })); }catch(e){}
    }

    let estoque = loadStock();
    estoque.items = (estoque.items||[]).map(it=>({
      sku: safe(it.sku).trim(),
      nome: safe(it.nome),
      categoria: safe(it.categoria),
      local: safe(it.local),
      qtd: toNum(it.qtd),
      alerta: toNum(it.alerta),
      preco: toNum(it.preco),
      custo: toNum(it.custo)
    }));

    /* ===== Estado/UI ===== */
    let editingSku = null;

    function rebuildCats(){
      const cats=[...new Set(estoque.items.map(i=>i.categoria).filter(Boolean))].sort();
      $('fCategoria').innerHTML = '<option value="">Todas</option>'+ cats.map(c=>'<option>'+c+'</option>').join('');
    }

    function getFiltered(){
      const q = ( $('search').value || '' ).toLowerCase();
      const cat = $('fCategoria').value;
      return estoque.items.filter(it=>{
        const mQ = !q || [it.sku,it.nome,it.categoria,it.local].join(' ').toLowerCase().includes(q);
        const mC = !cat || it.categoria===cat;
        return mQ && mC;
      });
    }

    function render(){
      const data = getFiltered();
      const tbody = $('tbody'), empty=$('empty');
      if(!data.length){ tbody.innerHTML=""; empty.style.display='block'; }
      else {
        empty.style.display='none';
        tbody.innerHTML = data.map(it=>{
          const totalPreco = (+it.preco||0) * (+it.qtd||0);
          return '<tr class="'+(isAlert(it)?'is-alert':'')+'">'+
            '<td class="nowrap">'+safe(it.sku)+'</td>'+
            '<td>'+safe(it.nome)+'</td>'+
            '<td><span class="badge-cat">'+(it.categoria||'-')+'</span></td>'+
            '<td>'+safe(it.local||'-')+'</td>'+
            '<td class="text-end">'+(it.qtd||0)+'</td>'+
            '<td class="text-end">'+(it.alerta||0)+'</td>'+
            '<td class="text-end">'+money(it.preco||0)+'</td>'+
            '<td class="text-end">'+money(it.custo||0)+'</td>'+
            '<td class="text-end">'+money(totalPreco)+'</td>'+
            '<td class="text-end nowrap">'+
              '<div class="btn-group btn-group-sm">'+
                '<button class="btn btn-outline-secondary" data-action="edit" data-sku="'+encodeURIComponent(it.sku)+'"><i class="bi bi-pencil-square"></i></button>'+
                '<button class="btn btn-outline-danger" data-action="del" data-sku="'+encodeURIComponent(it.sku)+'"><i class="bi bi-trash"></i></button>'+
              '</div>'+
            '</td>'+
          '</tr>';
        }).join('');
      }
      $('mItens').textContent = String(estoque.items.length||0);
      $('mLow').textContent = String(estoque.items.filter(x=> isAlert(x)).length);
      const valor = estoque.items.reduce((s,x)=> s + (x.preco||0) * (+x.qtd||0), 0);
      $('mValor').textContent = money(valor);
    }

    /* ===== CRUD Item ===== */
    $('btnNovo').addEventListener('click', ()=>{
      editingSku = null;
      $('modalTitle').textContent = "Novo item";
      $('formItem').reset();
      $('iQtd').value=0; $('iAlerta').value=0; $('iPreco').value=0; $('iCusto').value=0;
    });

    $('btnSalvarItem').addEventListener('click', ()=>{
      const sku = $('iSku').value.trim();
      const nome = $('iNome').value.trim();
      if(!sku || !nome){ $('formItem').classList.add('was-validated'); return; }
      const obj = {
        sku, nome,
        categoria: $('iCat').value.trim(),
        local: $('iLoc').value.trim(),
        qtd: toNum($('iQtd').value),
        alerta: toNum($('iAlerta').value),
        preco: toNum($('iPreco').value),
        custo: toNum($('iCusto').value)
      };

      const idx = estoque.items.findIndex(x=>x.sku===sku);
      if(editingSku && editingSku!==sku){
        if(idx>=0){ alert('Já existe um item com este SKU.'); return; }
        estoque.items = estoque.items.filter(x=>x.sku!==editingSku);
        estoque.items.push(obj);
      } else {
        if(idx>=0) estoque.items[idx]=obj; else estoque.items.push(obj);
      }

      saveStock(); rebuildCats(); render();
      bootstrap.Modal.getInstance(document.getElementById('modalItem'))?.hide();
    });

    $('tbody').addEventListener('click', (ev)=>{
      const btn = ev.target.closest('[data-action]'); if(!btn) return;
      const act = btn.dataset.action; const sku = decodeURIComponent(btn.dataset.sku||'');
      const it = estoque.items.find(x=>x.sku===sku);

      if(act==='edit' && it){
        editingSku = it.sku;
        $('modalTitle').textContent = "Editar item";
        $('iSku').value = it.sku; $('iNome').value = it.nome; $('iCat').value = it.categoria;
        $('iLoc').value = it.local; $('iQtd').value = it.qtd; $('iAlerta').value = it.alerta;
        $('iPreco').value = it.preco; $('iCusto').value = it.custo;
        new bootstrap.Modal(document.getElementById('modalItem')).show();
      }
      if(act==='del' && it){
        if(!confirm('Excluir este item?')) return;
        estoque.items = estoque.items.filter(x=>x.sku!==sku);
        saveStock(); rebuildCats(); render();
      }
    });

    /* ===== Filtros ===== */
    $('search').addEventListener('input', render);
    $('fCategoria').addEventListener('change', render);

    /* ===== Import/Export: Excel ===== */
    $('btnImportXLSX').addEventListener('click', ()=> $('fileXLSX').click());
    $('fileXLSX').addEventListener('change', function(){
      const f=this.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=function(e){
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const arr = XLSX.utils.sheet_to_json(ws, {defval:""});
        arr.forEach(r=>{
          const obj = {
            sku: safe((r.sku||r.SKU||r.Sku||"")).trim(),
            nome: safe(r.nome||r.Nome),
            categoria: safe(r.categoria||r.Categoria),
            local: safe(r.local||r.Local),
            qtd: toNum(r.qtd||r.Qtd||r.quantidade||r.Quantidade),
            alerta: toNum(r.alerta||r.Alerta),
            preco: toNum(r.preco||r.Preco||r.preço||r.Preço),
            custo: toNum(r.custo||r.Custo)
          };
          if(!obj.sku || !obj.nome) return;
          const i = estoque.items.findIndex(x=>x.sku===obj.sku);
          if(i>=0) estoque.items[i]=obj; else estoque.items.push(obj);
        });
        saveStock(); rebuildCats(); render();
        this.value="";
      };
      reader.readAsArrayBuffer(f);
    });

    $('btnExportXLSX').addEventListener('click', ()=>{
      const data = getFiltered();
      const rows = data.map(it=>({
        sku: it.sku, nome: it.nome, categoria: it.categoria, local: it.local,
        qtd: it.qtd, alerta: it.alerta, preco: it.preco, custo: it.custo,
        total_preco: (it.preco||0)*(it.qtd||0)
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Estoque");
      XLSX.writeFile(wb, "estoque.xlsx");
    });

    /* ===== Importar XML ===== */
    $('btnImportXML').addEventListener('click', ()=> $('fileXML').click());
    $('fileXML').addEventListener('change', function(){
      const f=this.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=function(e){
        try{
          const xmlStr = e.target.result;
          const doc = new DOMParser().parseFromString(xmlStr, 'application/xml');
          if (doc.getElementsByTagName('parsererror').length) throw new Error('XML inválido (erro de parser).');

          const byLocal = (node, tag) => {
            const out=[]; const all = node.getElementsByTagName('*');
            for(let i=0;i<all.length;i++){ if((all[i].localName||'').toLowerCase()===tag.toLowerCase()) out.push(all[i]); }
            return out;
          };
          const firstText = (node, tag) => (byLocal(node, tag)[0]?.textContent||"").trim();

          // 1) NF-e
          let dets = byLocal(doc, 'det');
          if (dets.length) {
            const tot = byLocal(doc, 'ICMSTot')[0] || byLocal(doc,'icmstot')[0];
            const vTot = (t) => toNum(tot ? firstText(tot, t) : 0);
            const freteTot = vTot('vFrete'), descTot = vTot('vDesc'), outroTot = vTot('vOutro'), segTot = vTot('vSeg');

            const itens = dets.map(det=>{
              const prod = byLocal(det,'prod')[0]; if(!prod) return null;
              const sku = firstText(prod,'cProd') || firstText(prod,'codigo') || firstText(prod,'cod') || firstText(prod,'sku');
              const nome= firstText(prod,'xProd') || firstText(prod,'nome') || firstText(prod,'descricao');
              const ncm = firstText(prod,'NCM')   || firstText(prod,'ncm') || '';
              const qCom= toNum(firstText(prod,'qCom') || firstText(prod,'quantidade') || firstText(prod,'qtd'));
              const vUnCom= toNum(firstText(prod,'vUnCom'));
              const vProd = toNum(firstText(prod,'vProd')) || (vUnCom*qCom);
              const vFreteItem = toNum(firstText(prod,'vFrete'));
              const vDescItem  = toNum(firstText(prod,'vDesc'));
              const vOutroItem = toNum(firstText(prod,'vOutro'));
              const vSegItem   = toNum(firstText(prod,'vSeg'));
              return {sku,nome,ncm,qCom,vUnCom,vProd,vFreteItem,vDescItem,vOutroItem,vSegItem};
            }).filter(Boolean);

            const somaVProd = itens.reduce((s,it)=> s + (it.vProd||0), 0) || 0;
            let imported = 0;
            for(const it of itens){
              if(!it.sku || !it.nome || !(it.qCom>0)) continue;
              const fator = somaVProd>0 ? (it.vProd / somaVProd) : 0;
              const freteUnit = (it.vFreteItem>0 ? it.vFreteItem : freteTot * fator) / (it.qCom||1);
              const outroUnit = (it.vOutroItem>0 ? it.vOutroItem : outroTot * fator) / (it.qCom||1);
              const segUnit   = (it.vSegItem>0   ? it.vSegItem   : segTot   * fator) / (it.qCom||1);
              const descUnit  = (it.vDescItem>0  ? it.vDescItem  : descTot  * fator) / (it.qCom||1);
              const custoUnit = toNum(it.vUnCom + freteUnit + outroUnit + segUnit - descUnit);

              const obj = { sku: safe(it.sku), nome: safe(it.nome), categoria: safe(it.ncm), local: "", qtd: it.qCom, alerta: 0, preco: 0, custo: custoUnit };
              const i = estoque.items.findIndex(x=>x.sku===obj.sku);
              if(i>=0) estoque.items[i]=obj; else estoque.items.push(obj);
              imported++;
            }
            if(imported===0) throw new Error('Nenhum item válido encontrado na NF-e.');
            saveStock(); rebuildCats(); render();
            alert(`Importação NF-e concluída: ${imported} item(ns).`); $('fileXML').value=""; return;
          }

          // 2) <estoque><item>
          let items = byLocal(doc,'item');
          if(items.length){
            items.forEach(n=>{
              const get = tag => (byLocal(n, tag)[0]?.textContent||"").trim();
              const obj = {
                sku: get('sku') || get('codigo') || get('cod') || get('id'),
                nome: get('nome') || get('descricao'),
                categoria: get('categoria') || get('ncm') || '',
                local: get('local') || '',
                qtd: toNum(get('quantidade') || get('qtd') || get('qCom')),
                alerta: toNum(get('alerta')),
                preco: 0,
                custo: toNum(get('custo') || get('vUnCom') || get('precoCusto'))
              };
              if(!obj.sku || !obj.nome) return;
              const i = estoque.items.findIndex(x=>x.sku===obj.sku);
              if(i>=0) estoque.items[i]=obj; else estoque.items.push(obj);
            });
            saveStock(); rebuildCats(); render();
            alert('Importação XML simples concluída.'); $('fileXML').value=""; return;
          }

          // 3) Formatos genéricos <produto>/<product>
          const candidatos = ['produto','product'];
          for(const tag of candidatos){
            const arr = byLocal(doc, tag);
            if(!arr.length) continue;
            arr.forEach(n=>{
              const map = {}; Array.from(n.children||[]).forEach(ch=> map[(ch.localName||ch.tagName||'').toLowerCase()] = ch.textContent.trim());
              const pick = (...keys)=>{ for(const k of keys){ if(map[k] && map[k]!=="-") return map[k]; } return ''; };
              const sku  = pick('cprod','sku','codigo','cod','code','id');
              const nome = pick('xprod','nome','descricao','description','name','produto','title');
              const ncm  = pick('ncm','categoria','category');
              const qtd  = toNum(pick('qcom','quantidade','qtd','qty','quantity','amount'));
              let custo  = toNum(pick('vuncom','custo','cost','preco_custo','unitcost'));
              const vprod = toNum(pick('vprod','valor_total','totalvalue')); if(!custo && vprod && qtd>0) custo = vprod / qtd;
              const obj = { sku: safe(sku), nome: safe(nome), categoria: safe(ncm), local: "", qtd, alerta:0, preco:0, custo };
              if(!obj.sku || !obj.nome || !(obj.qtd>0)) return;
              const i = estoque.items.findIndex(x=>x.sku===obj.sku);
              if(i>=0) estoque.items[i]=obj; else estoque.items.push(obj);
            });
            saveStock(); rebuildCats(); render();
            alert('Importação genérica concluída.'); $('fileXML').value=""; return;
          }

          alert('Não foi possível reconhecer o formato do XML.');
        }catch(err){
          alert('Falha ao ler XML: '+ err.message);
        } finally {
          $('fileXML').value="";
        }
      };
      reader.readAsText(f, 'utf-8');
    });

    /* ===== Exportar XML ===== */
    $('btnExportXML').addEventListener('click', ()=>{
      const data = getFiltered();
      const esc = s=> String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const body = data.map(x=>`  <item>
    <sku>${esc(x.sku)}</sku>
    <nome>${esc(x.nome)}</nome>
    <categoria>${esc(x.categoria||'')}</categoria>
    <local>${esc(x.local||'')}</local>
    <quantidade>${x.qtd||0}</quantidade>
    <alerta>${x.alerta||0}</alerta>
    <preco>${x.preco||0}</preco>
    <custo>${x.custo||0}</custo>
  </item>`).join('\n');
      const xml = `<?xml version="1.0" encoding="UTF-8"?>\n<estoque>\n${body}\n</estoque>`;
      const blob = new Blob([xml], {type:'application/xml;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='estoque.xml'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 0);
    });

    /* ===== Exportar PDF (itens listados) ===== */
    $('btnExportPDF').addEventListener('click', ()=>{
      const data = getFiltered();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
      const now = new Date();
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text("Rota Motos — Estoque (Itens listados)", 40, 40);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.text(now.toLocaleString('pt-BR'), 40, 58);
      const head = [['SKU','Nome','Categoria','Local','Qtd','Alerta','Preço','Custo','Total (Preço)']];
      const body = data.map(x=>[ x.sku, x.nome, x.categoria||'-', x.local||'-', String(x.qtd||0), String(x.alerta||0), toBRL(x.preco), toBRL(x.custo), toBRL((x.preco||0)*(x.qtd||0)) ]);
      const totalItens = data.length, totalValor = data.reduce((s,x)=> s + (x.preco||0)*(x.qtd||0), 0), totalLow = data.filter(x=> isAlert(x)).length;
      doc.autoTable({ head, body, startY: 72, styles: { font:'helvetica', fontSize:9, cellPadding:4, overflow:'linebreak' }, headStyles: { fillColor:[238,242,255], textColor:[30,27,75] },
        columnStyles: { 4:{ halign:'right', cellWidth:50 }, 5:{ halign:'right', cellWidth:60 }, 6:{ halign:'right', cellWidth:70 }, 7:{ halign:'right', cellWidth:70 }, 8:{ halign:'right', cellWidth:90 } },
        didParseCell: function(dc){ if(dc.section==='body'){ const row = data[dc.row.index]; if(isAlert(row)) dc.cell.styles.fillColor = [255,226,226]; } }
      });
      const y = doc.lastAutoTable.finalY + 18;
      doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text('Resumo', 40, y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(`Itens exibidos: ${totalItens}`, 40, y+18);
      doc.text(`Itens em alerta: ${totalLow}`, 40, y+34);
      doc.text(`Valor total (Preço): ${toBRL(totalValor)}`, 40, y+50);
      doc.save('estoque_listado.pdf');
      function toBRL(n){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(+n||0); }
    });

    /* ===== Somar itens repetidos (SKU) ===== */
    function mergeDuplicatesBySKU(){
      if(!estoque.items.length){ alert("Não há itens para mesclar."); return; }
      backupStock();
      const order=[], map=new Map(), norm = s => safe(s).trim().toUpperCase();
      for(const it of estoque.items){
        const key = norm(it.sku); if(!key) continue;
        if(!map.has(key)){
          map.set(key, { sku: safe(it.sku).trim(), nome: safe(it.nome), categoria: safe(it.categoria), local: safe(it.local), qtd: toNum(it.qtd), alerta: toNum(it.alerta), preco: toNum(it.preco), custo: toNum(it.custo) });
          order.push(key);
        } else {
          const base = map.get(key);
          base.qtd += toNum(it.qtd);
          base.alerta = Math.max(toNum(base.alerta), toNum(it.alerta));
          if(!base.nome && it.nome) base.nome = safe(it.nome);
          if(!base.categoria && it.categoria) base.categoria = safe(it.categoria);
          if(!base.local && it.local) base.local = safe(it.local);
          if(!(toNum(base.preco)>0) && (toNum(it.preco)>0)) base.preco = toNum(it.preco);
          if(!(toNum(base.custo)>0) && (toNum(it.custo)>0)) base.custo = toNum(it.custo);
        }
      }
      const merged = order.map(k=>map.get(k));
      const before = estoque.items.length, after = merged.length, removed = before - after;
      estoque.items = merged; saveStock(); rebuildCats(); render();
      alert(`Mesclagem concluída.\nSKU únicos: ${after}\nItens removidos (duplicados): ${removed}`);
    }
    $('btnMerge').addEventListener('click', ()=>{ if(confirm('Somar quantidades de itens com o mesmo SKU?\n(Um backup será salvo: "estoque.backup.last")')) mergeDuplicatesBySKU(); });

    /* ===== Init ===== */
    function init(){
      rebuildCats(); render();
    }
    init();
  })();
  </script>
</body>
</html>
