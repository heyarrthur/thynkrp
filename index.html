<!doctype html>
<html lang="pt-BR" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rota Motos | Estoque</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- SheetJS p/ Excel (XLSX/CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .rounded-xl{border-radius:1rem}
    .icon-wrap{width:44px;height:44px;border-radius:14px;display:grid;place-items:center}
    .status-badge{font-weight:600;font-size:.75rem;padding:.25rem .5rem;border-radius:.5rem}
    .st-ok{background:var(--bs-success-bg-subtle);color:var(--bs-success-text)}
    .st-low{background:var(--bs-warning-bg-subtle);color:var(--bs-warning-text)}
    .st-zero{background:var(--bs-danger-bg-subtle);color:var(--bs-danger-text)}
    .table td,.table th{vertical-align:middle}
    .import-hint{font-size:.85rem}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg border-bottom sticky-top bg-body">
    <div class="container-xxl">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <span class="d-inline-grid place-items-center rounded-3 bg-warning text-dark shadow-sm" style="width:34px;height:34px;font-size:.7rem"></span>
        <span class="fw-semibold">Rota Motos</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Estoque</a></li>
          <li class="nav-item"><a class="nav-link" href="oficina.html">Oficina</a></li>
          <li class="nav-item"><a class="nav-link" href="pedidos.html">Pedidos</a></li>
          <li class="nav-item"><a class="nav-link" href="financeiro.html">Financeiro</a></li>
        </ul>
        <div class="d-flex gap-2">
          <button id="btnTema" class="btn btn-outline-secondary" title="Tema claro/escuro"><i class="bi bi-moon-stars"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <main class="container-xxl py-4">

    <!-- KPIs -->
    <section class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-primary-subtle text-primary"><i class="bi bi-box-seam"></i></div>
            <div><div class="small text-body-secondary">Produtos</div><div id="kpiProdutos" class="h4 mb-0">0</div></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-info-subtle text-info"><i class="bi bi-123"></i></div>
            <div><div class="small text-body-secondary">Unidades</div><div id="kpiUnidades" class="h4 mb-0">0</div></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-success-subtle text-success"><i class="bi bi-cash-stack"></i></div>
            <div><div class="small text-body-secondary">Valor Total</div><div id="kpiValor" class="h4 mb-0">R$ 0,00</div></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-warning-subtle text-warning"><i class="bi bi-exclamation-triangle"></i></div>
            <div><div class="small text-body-secondary">Baixo Estoque</div><div id="kpiBaixo" class="h4 mb-0">0</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filtros + Ações -->
    <section class="card border-0 shadow-sm rounded-xl mb-3">
      <div class="card-header bg-body">
        <div class="d-flex flex-wrap align-items-end gap-2">
          <div class="input-group" style="max-width:360px">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="busca" class="form-control" placeholder="Buscar por SKU, nome, local...">
          </div>

          <div>
            <label class="form-label small mb-1">Categoria</label>
            <select id="filtroCat" class="form-select">
              <option value="">Todas</option>
            </select>
          </div>

          <div class="ms-auto d-flex flex-wrap gap-2">
            <button id="btnNovo" class="btn btn-warning text-dark"><i class="bi bi-plus-lg me-1"></i>Novo Produto</button>

            <!-- Import / Export -->
            <div class="btn-group" role="group" aria-label="Import/Export">
              <input id="fileImport" type="file" accept=".xml,.xlsx,.xls,.csv" class="d-none">
              <button id="btnImport" class="btn btn-outline-primary"><i class="bi bi-upload me-1"></i>Importar</button>
              <button id="btnExportXML" class="btn btn-outline-secondary"><i class="bi bi-filetype-xml me-1"></i>XML</button>
              <button id="btnExportXLSX" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-spreadsheet me-1"></i>Excel</button>
            </div>
          </div>
        </div>
        <div class="mt-2 d-flex align-items-center gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chkSomarQtd">
            <label class="form-check-label" for="chkSomarQtd">Somar quantidades ao importar</label>
          </div>
          <div class="import-hint text-body-secondary">
            <i class="bi bi-info-circle me-1"></i>
            Excel/CSV: use cabeçalhos como <code>SKU, Nome, Categoria, Localização, Quantidade, Alerta, Preço, Custo</code>.
            XML: <code>&lt;estoque&gt;&lt;item&gt;...&lt;/item&gt;&lt;/estoque&gt;</code>
          </div>
        </div>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>SKU</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Local</th>
                <th class="text-end">Qtd</th>
                <th class="text-end">Alerta</th>
                <th class="text-end">Preço</th>
                <th class="text-end">Custo</th>
                <th>Status</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Produto -->
  <div class="modal fade" id="prodModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content rounded-xl">
        <form id="formProd" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="tituloModal">Novo produto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="skuOld">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">SKU</label>
                <input id="sku" class="form-control" placeholder="SKU único">
              </div>
              <div class="col-md-8">
                <label class="form-label">Nome do produto <span class="text-danger">*</span></label>
                <input id="nome" class="form-control" required>
                <div class="invalid-feedback">Informe o nome.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Categoria <span class="text-danger">*</span></label>
                <input id="categoria" class="form-control" required>
                <div class="invalid-feedback">Informe a categoria.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Localização</label>
                <input id="local" class="form-control" placeholder="Prateleira A">
              </div>

              <div class="col-md-4">
                <label class="form-label">Quantidade <span class="text-danger">*</span></label>
                <input id="qtd" type="number" min="0" step="1" class="form-control" required>
                <div class="invalid-feedback">Informe a quantidade.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Alerta (mínimo) <span class="text-danger">*</span></label>
                <input id="alerta" type="number" min="0" step="1" class="form-control" required>
                <div class="invalid-feedback">Informe o alerta mínimo.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Preço (R$) <span class="text-danger">*</span></label>
                <input id="preco" type="number" min="0" step="0.01" class="form-control" required>
                <div class="invalid-feedback">Informe o preço.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Custo (R$)</label>
                <input id="custo" type="number" min="0" step="0.01" class="form-control" value="0">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-warning text-dark" type="submit">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toasts"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  'use strict';
  // ===== Helpers =====
  const $ = (id)=> document.getElementById(id);
  const fmtBRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  function toast(msg,variant='success'){
    const map={success:'text-bg-success',danger:'text-bg-danger',warning:'text-bg-warning text-dark',info:'text-bg-info'};
    const el=document.createElement('div'); el.className=`toast ${map[variant]||''}`;
    el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    $('toasts').appendChild(el); const t=new bootstrap.Toast(el,{delay:2500,autohide:true}); el.addEventListener('hidden.bs.toast',()=>el.remove()); t.show();
  }
  // Tema
  const TEMA_KEY='estoque_tema';
  function aplicarTema(t){ document.documentElement.setAttribute('data-bs-theme',t); $('btnTema').innerHTML=(t==='dark')?'<i class="bi bi-sun"></i>':'<i class="bi bi-moon-stars"></i>'; }
  aplicarTema(localStorage.getItem(TEMA_KEY)||'light');
  $('btnTema').addEventListener('click',()=>{ const a=document.documentElement.getAttribute('data-bs-theme')||'light'; const p=a==='light'?'dark':'light'; aplicarTema(p); localStorage.setItem(TEMA_KEY,p); });

  // ===== Storage =====
  const K_ESTOQUE='estoque_itens';
  const loadEstoque=()=>{ try{return JSON.parse(localStorage.getItem(K_ESTOQUE)||'[]');}catch{return [];} };
  const saveEstoque=(a)=> localStorage.setItem(K_ESTOQUE, JSON.stringify(a));

  // ===== Estado =====
  let ESTOQUE = loadEstoque();
  function categorias(){ return [...new Set(ESTOQUE.map(i=>i.categoria).filter(Boolean))].sort(); }

  // ===== UI =====
  function statusBadge(qtd, alerta){
    if(qtd<=0) return '<span class="status-badge st-zero">Zerado</span>';
    if(qtd<=alerta) return '<span class="status-badge st-low">Baixo</span>';
    return '<span class="status-badge st-ok">Ok</span>';
  }
  function renderKPIs(){
    const prods = ESTOQUE.length;
    const unidades = ESTOQUE.reduce((s,i)=> s+(+i.qtd||0), 0);
    const total = ESTOQUE.reduce((s,i)=> s+((+i.preco||0)*(+i.qtd||0)), 0);
    const baixos = ESTOQUE.filter(i=> (+i.qtd||0)<=(+i.alerta||0)).length;
    $('kpiProdutos').textContent=prods;
    $('kpiUnidades').textContent=unidades;
    $('kpiValor').textContent=fmtBRL.format(total);
    $('kpiBaixo').textContent=baixos;
  }
  function fillCategorias(){
    const sel=$('filtroCat'); const cur=sel.value;
    sel.innerHTML='<option value="">Todas</option>'+categorias().map(c=>`<option>${c}</option>`).join('');
    if(cur) sel.value=cur;
  }
  function renderTabela(){
    renderKPIs(); fillCategorias();
    const q = $('busca').value.trim().toLowerCase();
    const cat = $('filtroCat').value;
    const tb = $('tbody'); tb.innerHTML='';
    let list = ESTOQUE.filter(i=>{
      const okCat = !cat || i.categoria===cat;
      const okQ = !q || [i.sku,i.nome,i.categoria,i.local].join(' ').toLowerCase().includes(q);
      return okCat && okQ;
    });
    if(list.length===0){
      tb.innerHTML='<tr><td colspan="10" class="text-center py-5 text-body-secondary">Nenhum item.</td></tr>'; return;
    }
    for(const p of list){
      const tr=document.createElement('tr');
      const isLow = (+p.qtd||0)<=(+p.alerta||0);
      if(isLow) tr.classList.add('table-danger'); // linha em vermelho
      tr.innerHTML=`
        <td>${p.sku||''}</td>
        <td>${p.nome||''}</td>
        <td>${p.categoria||''}</td>
        <td>${p.local||''}</td>
        <td class="text-end">${+p.qtd||0}</td>
        <td class="text-end">${+p.alerta||0}</td>
        <td class="text-end">${fmtBRL.format(+p.preco||0)}</td>
        <td class="text-end">${fmtBRL.format(+p.custo||0)}</td>
        <td>${statusBadge(+p.qtd||0, +p.alerta||0)}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-warning text-dark" data-edit="${p.sku||''}"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-outline-danger" data-del="${p.sku||''}"><i class="bi bi-trash"></i></button>
          </div>
        </td>`;
      tb.appendChild(tr);
    }
  }

  // ===== CRUD =====
  const modalEl = document.getElementById('prodModal');
  function abrirNovo(){
    $('tituloModal').textContent='Novo produto';
    $('skuOld').value='';
    $('sku').value=''; $('nome').value=''; $('categoria').value=''; $('local').value='';
    $('qtd').value='0'; $('alerta').value='0'; $('preco').value='0'; $('custo').value='0';
    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  }
  function abrirEditar(sku){
    const p=ESTOQUE.find(x=>String(x.sku)===String(sku)); if(!p) return;
    $('tituloModal').textContent='Editar produto';
    $('skuOld').value=p.sku||'';
    $('sku').value=p.sku||''; $('nome').value=p.nome||''; $('categoria').value=p.categoria||''; $('local').value=p.local||'';
    $('qtd').value=+p.qtd||0; $('alerta').value=+p.alerta||0; $('preco').value=+p.preco||0; $('custo').value=+p.custo||0;
    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  }

  $('formProd').addEventListener('submit',(e)=>{
    e.preventDefault();
    const f=e.target; f.classList.add('was-validated'); if(!f.checkValidity()) return;
    const obj={
      sku: $('sku').value.trim(),
      nome: $('nome').value.trim(),
      categoria: $('categoria').value.trim(),
      local: $('local').value.trim(),
      qtd: Math.max(0, parseInt($('qtd').value||'0',10)),
      alerta: Math.max(0, parseInt($('alerta').value||'0',10)),
      preco: Math.max(0, parseFloat($('preco').value||'0')),
      custo: Math.max(0, parseFloat($('custo').value||'0'))
    };
    const existingIdx = ESTOQUE.findIndex(x=> String(x.sku)===String($('skuOld').value||obj.sku));
    if(existingIdx>=0){
      // se mudou SKU, garantir unicidade
      if(obj.sku!==ESTOQUE[existingIdx].sku && ESTOQUE.some(z=>String(z.sku)===obj.sku)){ toast('SKU já existente.','danger'); return; }
      ESTOQUE[existingIdx]=obj;
      toast('Produto atualizado.','success');
    }else{
      if(!obj.sku){ obj.sku = 'SKU-'+Math.random().toString(36).slice(2,8).toUpperCase(); }
      if(ESTOQUE.some(z=>String(z.sku)===obj.sku)){ toast('SKU já existente.','danger'); return; }
      ESTOQUE.unshift(obj);
      toast('Produto cadastrado.','success');
    }
    saveEstoque(ESTOQUE);
    bootstrap.Modal.getOrCreateInstance(modalEl).hide();
    renderTabela();
  });

  document.addEventListener('click',(e)=>{
    const del=e.target.closest('[data-del]'); if(del){
      const sku=del.dataset.del; if(!confirm('Excluir este item?')) return;
      ESTOQUE = ESTOQUE.filter(x=> String(x.sku)!==String(sku));
      saveEstoque(ESTOQUE); renderTabela(); toast('Item excluído.','danger'); return;
    }
    const ed=e.target.closest('[data-edit]'); if(ed){ abrirEditar(ed.dataset.edit); return; }
  });
  $('btnNovo').addEventListener('click', abrirNovo);
  $('busca').addEventListener('input', renderTabela);
  $('filtroCat').addEventListener('change', renderTabela);

  // ===== Import / Export =====
  function download(filename, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
  function parseBRNumber(v){
    if(typeof v === 'number') return v;
    if(v==null) return 0;
    const s = String(v).trim().replace(/\s+/g,'').replace(/\./g,'').replace(/,/g,'.');
    const n = parseFloat(s); return isNaN(n)?0:n;
  }
  function parseIntSafe(v){ const n = parseBRNumber(v); return isFinite(n)? Math.round(n):0; }
  function normalizeRow(row){
    const get = (...keys)=>{ for(const k of keys){ if(row[k] != null && row[k] !== '') return row[k]; } return ''; };
    return {
      sku:       String(get('SKU','Sku','sku','Código','Codigo','codigo')).trim(),
      nome:      String(get('Nome','Produto','Descrição','Descricao','descricao')).trim(),
      categoria: String(get('Categoria','Categoria*','Grupo','Depto')).trim(),
      local:     String(get('Local','Localização','Localizacao','Prateleira','Posição')).trim(),
      qtd:       parseIntSafe(get('Quantidade','Qtd','Estoque','Qtde')),
      alerta:    parseIntSafe(get('Alerta','Alerta estoque','AlertaEstoque','Estoque mínimo','Min')),
      preco:     parseBRNumber(get('Preco','Preço','preco','Unitário','Venda')),
      custo:     parseBRNumber(get('Custo','Custo Unitário','custo'))
    };
  }
  function validateItem(it){
    return it && it.nome && Number.isFinite(+it.qtd) && Number.isFinite(+it.preco);
  }
  function mergeImport(items, opts){
    const options = Object.assign({ sumQty: $('chkSomarQtd').checked || false }, opts||{});
    const map = new Map(ESTOQUE.map(i=> [String(i.sku||''), i]));
    let novos=0, atualizados=0, ignorados=0;

    for(const raw of items){
      const it = {
        sku: String(raw.sku||'').trim(),
        nome: String(raw.nome||'').trim(),
        categoria: String(raw.categoria||'').trim(),
        local: String(raw.local||'').trim(),
        qtd: parseIntSafe(raw.qtd||0),
        alerta: parseIntSafe(raw.alerta||0),
        preco: parseBRNumber(raw.preco||0),
        custo: parseBRNumber(raw.custo||0)
      };
      if(!validateItem(it)){ ignorados++; continue; }

      const key = it.sku || it.nome; // se não tiver SKU, usa nome como chave
      if(map.has(key)){
        const cur = map.get(key);
        cur.qtd = options.sumQty ? ((+cur.qtd||0) + (+it.qtd||0)) : (+it.qtd||0);
        cur.nome = it.nome || cur.nome;
        cur.categoria = it.categoria || cur.categoria;
        cur.local = it.local || cur.local;
        if(Number.isFinite(it.alerta)) cur.alerta = it.alerta;
        if(Number.isFinite(it.preco))  cur.preco  = it.preco;
        if(Number.isFinite(it.custo))  cur.custo  = it.custo;
        atualizados++;
      }else{
        // se não veio SKU, gera um
        if(!it.sku) it.sku = 'SKU-'+Math.random().toString(36).slice(2,8).toUpperCase();
        map.set(it.sku, it); novos++;
      }
    }
    ESTOQUE = Array.from(map.values());
    saveEstoque(ESTOQUE);
    renderTabela();
    if(novos) toast(`${novos} item(ns) incluído(s).`,'success');
    if(atualizados) toast(`${atualizados} item(ns) atualizado(s).`,'info');
    if(ignorados) toast(`${ignorados} linha(s) ignorada(s).`,'warning');
    return {novos, atualizados, ignorados};
  }

  // Importar XML
  async function importXML(text){
    try{
      const xml = new DOMParser().parseFromString(text, 'application/xml');
      const nodes = xml.getElementsByTagName('item');
      const rows = [];
      for(const node of nodes){
        rows.push({
          sku: node.getElementsByTagName('sku')[0]?.textContent ?? '',
          nome: node.getElementsByTagName('nome')[0]?.textContent ?? '',
          categoria: node.getElementsByTagName('categoria')[0]?.textContent ?? '',
          local: node.getElementsByTagName('local')[0]?.textContent ?? '',
          qtd: node.getElementsByTagName('qtd')[0]?.textContent ?? '0',
          alerta: node.getElementsByTagName('alerta')[0]?.textContent ?? '0',
          preco: node.getElementsByTagName('preco')[0]?.textContent ?? '0',
          custo: node.getElementsByTagName('custo')[0]?.textContent ?? '0'
        });
      }
      mergeImport(rows);
    }catch(err){
      console.error(err); toast('XML inválido.','danger');
    }
  }

  // Importar Excel/CSV
  async function importExcel(arrayBuffer){
    try{
      const wb = XLSX.read(arrayBuffer, {type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, {defval:'', raw:false});
      const rows = json.map(normalizeRow);
      mergeImport(rows);
    }catch(err){
      console.error(err); toast('Falha ao ler planilha.','danger');
    }
  }

  // Exportar XML
  function exportXML(){
    const esc = (s)=> String(s==null?'':s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const body = ESTOQUE.map(i=>`
  <item>
    <sku>${esc(i.sku||'')}</sku>
    <nome>${esc(i.nome||'')}</nome>
    <categoria>${esc(i.categoria||'')}</categoria>
    <local>${esc(i.local||'')}</local>
    <qtd>${+i.qtd||0}</qtd>
    <alerta>${+i.alerta||0}</alerta>
    <preco>${(+i.preco||0).toFixed(2)}</preco>
    <custo>${(+i.custo||0).toFixed(2)}</custo>
  </item>`).join('');
    const xml = `<?xml version="1.0" encoding="utf-8"?>\n<estoque>${body}\n</estoque>`;
    download(`estoque-${new Date().toISOString().slice(0,10)}.xml`, new Blob([xml],{type:'application/xml'}));
  }

  // Exportar Excel
  function exportXLSX(){
    const rows = ESTOQUE.map(i=>({
      SKU: i.sku || '',
      Nome: i.nome || '',
      Categoria: i.categoria || '',
      "Localização": i.local || '',
      Quantidade: +i.qtd || 0,
      Alerta: +i.alerta || 0,
      "Preço": +i.preco || 0,
      "Custo": +i.custo || 0
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Estoque');
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    download(`estoque-${new Date().toISOString().slice(0,10)}.xlsx`, new Blob([wbout],{type:'application/octet-stream'}));
  }

  // Eventos Import/Export
  $('btnImport').addEventListener('click', ()=> $('fileImport').click());
  $('fileImport').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const name=f.name.toLowerCase();
    try{
      if(name.endsWith('.xml')){
        const text = await f.text(); await importXML(text);
      }else{
        const buf = await f.arrayBuffer(); await importExcel(buf);
      }
      toast('Importação concluída.','success');
    }catch(err){
      toast('Falha na importação.','danger');
    }finally{
      e.target.value='';
    }
  });
  $('btnExportXML').addEventListener('click', exportXML);
  $('btnExportXLSX').addEventListener('click', exportXLSX);

  // ===== Init =====
  renderTabela();
  </script>
</body>
</html>
