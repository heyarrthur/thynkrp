<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rota Motos — Serviços Extras</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --ink:#0f172a; --muted:#6b7280; --border:#e6e8ef; --accent:#f59e0b;
  --bg:#f6f8fb; --card:#fff;
  --sidebar:#ffffff; --side-txt:#0f172a; --side-dim:#6b7280;
  --side-w:260px; --side-collapsed:74px; --radius:12px;
  --shadow:0 10px 30px rgba(2,6,23,.06); --shadow-strong:0 14px 40px rgba(2,6,23,.12);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg); color:var(--ink); margin:0;
  overflow-y:scroll; transition:padding .25s ease;
  padding-left:var(--side-w);
}

/* ===== Sidebar (branca) ===== */
.sidebar{
  position:fixed; inset:0 auto 0 0; width:var(--side-w);
  background:var(--sidebar); color:var(--side-txt);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column; z-index:1030;
  transition:width .25s ease, box-shadow .25s ease;
  box-shadow:var(--shadow);
}
.brand{ display:flex; align-items:center; gap:.6rem; padding:16px 16px 14px; font-weight:800 }
.brand .logo{ width:36px; height:36px; border-radius:10px; background:#111; color:#fff; display:grid; place-items:center }
.nav-scroll{flex:1; overflow:auto; padding:8px 8px 16px}
.side-group{margin:8px 8px 14px}
.side-divider{height:1px; background:var(--border); margin:6px 10px 8px; border-radius:99px}
.side-sub{font-size:.8rem; color:var(--side-dim); margin:8px 10px 6px}
.side-item{
  display:flex; align-items:center; gap:.7rem; color:var(--side-txt); text-decoration:none;
  padding:10px 12px; border-radius:12px; font-weight:600;
  transition:transform .1s ease, background .2s ease, box-shadow .2s ease;
}
.side-item:hover{ background:rgba(15,23,42,.05); transform:translateY(-1px) }
.side-item.active{ background:#fff7ed; box-shadow:inset 0 0 0 2px #fde68a; color:#7c2d12 }
.side-toggle{
  display:flex; align-items:center; justify-content:center;
  margin:10px; border:1px solid var(--border); border-radius:12px; height:44px;
  background:#fff; color:var(--side-txt); width:calc(100% - 20px);
  box-shadow:var(--shadow); transition:transform .1s ease, box-shadow .2s ease;
}
.side-toggle:hover{ transform:translateY(-1px); box-shadow:var(--shadow-strong) }

/* Colapsar = só ícones */
body.collapsed{ padding-left:var(--side-collapsed) }
body.collapsed .sidebar{ width:var(--side-collapsed) }
.hide-on-collapse{ transition:opacity .15s ease }
body.collapsed .hide-on-collapse{ opacity:0; pointer-events:none; width:0 !important; display:none !important }
.show-on-collapse{ display:none }
body.collapsed .show-on-collapse{ display:flex }

/* ===== Topbar ===== */
.topbar{
  position:sticky; top:0; z-index:1010; padding:12px 0; margin-bottom:8px;
  background:linear-gradient(180deg,#ffffffcc,#ffffffaa 60%,#ffffff00);
  backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--border);
}

/* ===== Animações / cards ===== */
.container{max-width:1180px}
.card-soft{
  background:var(--card); border:1px solid var(--border); border-radius:16px;
  box-shadow:var(--shadow); transition:transform .12s ease, box-shadow .2s ease;
}
.card-soft:hover{ transform:translateY(-2px); box-shadow:var(--shadow-strong) }

.toolbar{ background:#fff; border:1px solid var(--border); border-left:4px solid var(--accent);
  border-radius:16px; padding:1rem; box-shadow:var(--shadow) }
.form-control,.form-select{border-radius:12px;border-color:var(--border)}
.form-control:focus,.form-select:focus{box-shadow:0 0 0 .25rem rgba(245,158,11,.16);border-color:#fcd34d}
.btn-ghost{background:#fff;border:1px solid var(--border);font-weight:600;border-radius:12px; transition:transform .1s ease, box-shadow .2s ease}
.btn-ghost:hover{background:#f9fafb; transform:translateY(-1px); box-shadow:var(--shadow)}
.btn-primary-clean{background:var(--accent);color:#111;border:1px solid #fbbf24;font-weight:700;border-radius:12px; transition:transform .1s ease, box-shadow .2s ease}
.btn-primary-clean:hover{ transform:translateY(-1px); box-shadow:var(--shadow-strong) }

.table thead th{background:#eef2ff;color:#1e1b4b;font-weight:700}
.badge-soft{background:#f1f5f9;border:1px solid #e2e8f0;color:#334155;border-radius:999px;padding:.15rem .5rem;font-weight:700;font-size:.72rem}

.modal-lg{--bs-modal-width: 900px}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="brand">
    <span class="logo">RM</span>
    <div class="hide-on-collapse">Rota Motos</div>
  </div>

  <div class="nav-scroll">
    <div class="side-divider"></div>

    <div class="side-group">
      <div class="side-sub">Estoque</div>
      <a class="side-item" href="index.html"><i class="bi bi-box-seam"></i><span class="hide-on-collapse">Gerenciar</span></a>
    </div>

    <div class="side-group">
      <div class="side-sub">Mecânica</div>
      <a class="side-item" href="oficina.html"><i class="bi bi-wrench-adjustable"></i><span class="hide-on-collapse">Oficina</span></a>
      <a class="side-item active" href="oficinaextras.html"><i class="bi bi-gear-wide-connected"></i><span class="hide-on-collapse">Serviços Extras</span></a>
    </div>

    <div class="side-group">
      <div class="side-sub">Financeiro</div>
      <a class="side-item" href="financeiro.html"><i class="bi bi-currency-dollar"></i><span class="hide-on-collapse">Faturamento</span></a>
    </div>

    <div class="side-group">
      <div class="side-sub">Vendas</div>
      <a class="side-item" href="vendas.html"><i class="bi bi-receipt"></i><span class="hide-on-collapse">Vendas</span></a>
    </div>

    <div class="side-group">
      <div class="side-sub">Configurações</div>
      <a class="side-item" href="backup.html"><i class="bi bi-receipt"></i><span class="hide-on-collapse">Backups</span></a>
    </div>
  </div>

  <button id="btnToggleSide" class="side-toggle">
    <i class="bi bi-chevron-left"></i>
    <span class="hide-on-collapse ms-2">Recolher</span>
    <i class="bi bi-chevron-right show-on-collapse"></i>
  </button>
</aside>

<!-- CONTEÚDO -->
<div class="topbar">
  <div class="container d-flex align-items-center justify-content-between">
    <h1 class="h5 m-0 fw-bold">Serviços Extras</h1>
    <div class="text-muted small">Rota Motos</div>
  </div>
</div>

<div class="container pb-4">

  <!-- TOOLBAR -->
  <div class="toolbar mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-lg-5">
        <label class="form-label mb-1">Buscar</label>
        <input id="search" class="form-control" placeholder="nome do serviço, categoria...">
      </div>
      <div class="col-lg-3">
        <label class="form-label mb-1">Categoria</label>
        <select id="fCategoria" class="form-select"><option value="">Todas</option></select>
      </div>
      <div class="col-lg-2">
        <label class="form-label mb-1">Ordenar por</label>
        <select id="fSort" class="form-select">
          <option value="nome">Nome (A-Z)</option>
          <option value="categoria">Categoria (A-Z)</option>
          <option value="preco">Preço (menor → maior)</option>
        </select>
      </div>
      <div class="col-lg-2 d-grid">
        <label class="form-label mb-1 d-block"> </label>
        <button id="btnNovo" class="btn btn-primary-clean"><i class="bi bi-plus-lg"></i> Novo</button>
      </div>

      <div class="col-12 d-flex gap-2">
        <button id="btnExport" class="btn btn-ghost"><i class="bi bi-cloud-download"></i> Exportar</button>
        <label class="btn btn-ghost mb-0">
          <i class="bi bi-cloud-upload"></i> Importar
          <input id="fileImport" type="file" accept="application/json" hidden>
        </label>
        <div class="ms-auto small text-muted">
          <span id="count">0</span> serviços
        </div>
      </div>
    </div>
  </div>

  <!-- LISTA -->
  <div class="card-soft p-0">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Categoria</th>
            <th class="text-end">Preço</th>
            <th style="width:160px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="text-center text-muted py-4">Nenhum serviço cadastrado.</div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalSvc" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 id="modalTitle" class="modal-title">Novo serviço</h5>
      <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form id="formSvc" class="needs-validation" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nome</label>
            <input id="iNome" class="form-control" required>
            <div class="invalid-feedback">Informe o nome do serviço.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Categoria</label>
            <input id="iCategoria" class="form-control" list="catsList" placeholder="ex.: Higienização">
            <datalist id="catsList"></datalist>
          </div>
          <div class="col-md-2">
            <label class="form-label">Preço</label>
            <input id="iPreco" type="number" step="0.01" min="0" value="0" class="form-control" required>
            <div class="invalid-feedback">Preço inválido.</div>
          </div>
          <div class="col-12 d-grid">
            <button id="btnSalvar" type="submit" class="btn btn-primary-clean"><i class="bi bi-check2-circle"></i> Salvar</button>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" data-bs-dismiss="modal">Fechar</button>
    </div>
  </div></div>
</div>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="toastOK" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">Salvo com sucesso.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <div id="toastERR" class="toast align-items-center text-bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">Erro ao salvar. Veja o console.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {
  const EXTRAS_KEY='oficina.extras.v1';
  const $ = id => document.getElementById(id);
  const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  const toast = (id)=> new bootstrap.Toast($(id)).show();
  const money = n => BRL.format(+n||0);

  /* Sidebar toggle */
  $('btnToggleSide').addEventListener('click', ()=> document.body.classList.toggle('collapsed'));

  /* Storage helpers */
  function loadExtras(){
    try{
      const raw=localStorage.getItem(EXTRAS_KEY);
      if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr)) return arr; }
    }catch(e){ console.error('Falha ao ler extras:', e); }
    return [
      {nome:'Lavagem completa', categoria:'Higienização', preco:30},
      {nome:'Regulagem de corrente', categoria:'Ajustes', preco:25},
      {nome:'Troca de óleo', categoria:'Fluidos', preco:45},
      {nome:'Polimento farol', categoria:'Estética', preco:35},
    ];
  }
  function saveExtras(arr){
    localStorage.setItem(EXTRAS_KEY, JSON.stringify(arr));
  }

  /* Estado */
  let data = loadExtras().map(s=>({id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2), nome:String(s.nome||''), categoria:String(s.categoria||''), preco:Number(s.preco||0)}));
  // Se não existia, grava para ficar disponível na oficina
  if(!localStorage.getItem(EXTRAS_KEY)) saveExtras(data);

  let editingId = null;

  /* UI */
  function rebuildCats(){
    const cats = [...new Set(data.map(x=>x.categoria).filter(Boolean))].sort();
    // filtro
    $('fCategoria').innerHTML = '<option value="">Todas</option>' + cats.map(c=>`<option>${c}</option>`).join('');
    // datalist do modal
    $('catsList').innerHTML = cats.map(c=>`<option value="${c}">`).join('');
  }

  function render(){
    const q = ($('search').value||'').toLowerCase();
    const cat = $('fCategoria').value;
    const sort = $('fSort').value;

    let arr = data.filter(x=>{
      const mq = !q || [x.nome,x.categoria].join(' ').toLowerCase().includes(q);
      const mc = !cat || x.categoria===cat;
      return mq && mc;
    });

    if(sort==='nome') arr.sort((a,b)=>a.nome.localeCompare(b.nome,'pt'));
    if(sort==='categoria') arr.sort((a,b)=>a.categoria.localeCompare(b.categoria,'pt') || a.nome.localeCompare(b.nome,'pt'));
    if(sort==='preco') arr.sort((a,b)=>a.preco-b.preco);

    $('count').textContent = arr.length;
    const tbody = $('tbody'), empty=$('empty');
    if(!arr.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
    empty.style.display='none';

    tbody.innerHTML = arr.map(s=>`
      <tr>
        <td class="fw-semibold">${escapeHTML(s.nome||'-')}</td>
        <td><span class="badge-soft">${escapeHTML(s.categoria||'-')}</span></td>
        <td class="text-end">${money(s.preco)}</td>
        <td>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-ghost" data-action="edit" data-id="${s.id}"><i class="bi bi-pencil"></i> Editar</button>
            <button class="btn btn-sm btn-ghost" data-action="del" data-id="${s.id}"><i class="bi bi-trash3"></i> Excluir</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function escapeHTML(s){ return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

  /* Eventos topo */
  $('search').addEventListener('input', render);
  $('fCategoria').addEventListener('change', render);
  $('fSort').addEventListener('change', render);

  /* Novo / Editar */
  const modal = new bootstrap.Modal(document.getElementById('modalSvc'));
  $('btnNovo').addEventListener('click', ()=>{
    editingId = null;
    $('modalTitle').textContent='Novo serviço';
    $('formSvc').reset();
    $('iPreco').value = 0;
    modal.show();
  });

  $('tbody').addEventListener('click', (ev)=>{
    const btn = ev.target.closest('[data-action]'); if(!btn) return;
    const id = btn.dataset.id;
    if(btn.dataset.action==='edit'){
      const s = data.find(x=>x.id===id); if(!s) return;
      editingId = s.id;
      $('modalTitle').textContent='Editar serviço';
      $('iNome').value = s.nome; $('iCategoria').value = s.categoria; $('iPreco').value = s.preco;
      modal.show();
    }
    if(btn.dataset.action==='del'){
      const s = data.find(x=>x.id===id); if(!s) return;
      if(confirm(`Excluir o serviço "${s.nome}"?`)){
        data = data.filter(x=>x.id!==id);
        saveExtras(data); rebuildCats(); render();
      }
    }
  });

  $('formSvc').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
    const form = ev.currentTarget;
    if(!form.checkValidity()){ form.classList.add('was-validated'); return; }

    const nome = $('iNome').value.trim();
    const categoria = $('iCategoria').value.trim();
    const preco = +$('iPreco').value || 0;

    try{
      if(editingId){
        const i = data.findIndex(x=>x.id===editingId);
        if(i>=0) data[i] = {...data[i], nome, categoria, preco};
      }else{
        data.push({id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2), nome, categoria, preco});
      }
      saveExtras(data);
      toast('toastOK');
      modal.hide();
      rebuildCats();
      render();
    }catch(e){
      console.error('Erro ao salvar:', e);
      toast('toastERR');
    }
  });

  /* Exportar / Importar */
  function fileTimestamp(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+'-'+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds()); }
  $('btnExport').addEventListener('click', ()=>{
    try{
      const payload = { meta:{ app:'Rota Motos', type:'extras', version:'1.0', created_at:new Date().toISOString() }, dados:data };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `rota-motos-servicos-extras-${fileTimestamp()}.json`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 200);
    }catch(e){ console.error(e); }
  });

  $('fileImport').addEventListener('change', (ev)=>{
    const file = ev.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const json = JSON.parse(reader.result);
        const arr = (json && (json.dados||json)) || [];
        if(!Array.isArray(arr)) throw new Error('Formato inválido');
        // normaliza
        const mapped = arr.map(s=>({
          id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
          nome:String(s.nome||''), categoria:String(s.categoria||''), preco:Number(s.preco||0)
        }));
        data = mapped;
        saveExtras(data);
        rebuildCats(); render(); toast('toastOK');
      }catch(e){ console.error('Falha no import:', e); alert('Arquivo inválido.'); }
      ev.target.value = '';
    };
    reader.readAsText(file);
  });

  /* Init */
  rebuildCats();
  render();
});
</script>
</body>
</html>
