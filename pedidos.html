<!doctype html>
<html lang="pt-BR" data-bs-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rota Motos | Pedidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/app.css">

  <!-- ...conteúdo... -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/print.js"></script>
  <!-- SÓ na página de pedidos -->
  <script src="assets/js/pedidos.js"></script>
  <style>
    :root {
      /* Largura padrão do cupom: mude para 58mm, 80mm, 100% (A4) */
      --receipt-width: 80mm;
      --print-margin: 6mm;
    }

    .rounded-xl {
      border-radius: 1rem
    }

    .table td,
    .table th {
      vertical-align: middle
    }

    .icon-wrap {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: grid;
      place-items: center
    }

    .status-badge {
      font-weight: 600;
      font-size: .75rem;
      padding: .25rem .5rem;
      border-radius: .5rem
    }

    .st-ok {
      background: var(--bs-success-bg-subtle);
      color: var(--bs-success-text)
    }

    .st-pen {
      background: var(--bs-warning-bg-subtle);
      color: var(--bs-warning-text)
    }

    .st-sep {
      background: var(--bs-info-bg-subtle);
      color: var(--bs-info-text)
    }

    .parts-panel {
      border: 1px dashed var(--bs-border-color);
      border-radius: .75rem;
      padding: 1rem
    }

    .parts-scroll {
      max-height: 240px;
      overflow: auto
    }

    .selected-scroll {
      max-height: 200px;
      overflow: auto
    }

    .sticky-subhead {
      position: sticky;
      top: 0;
      background: var(--bs-body-bg);
      z-index: 2
    }

    .qty-input {
      width: 76px
    }

    /* CUPOM / IMPRESSÃO */
    .receipt {
      width: var(--receipt-width);
      margin: 0 auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.38;
      color: #000;
    }

    .rc-center {
      text-align: center
    }

    .rc-hr {
      border-top: 1px dashed #000;
      margin: .45rem 0
    }

    .rc-title {
      font-weight: 700;
      text-transform: uppercase
    }

    .rc-slim {
      margin: .2rem 0
    }

    .rc-small {
      font-size: 11px
    }

    .rc-strong {
      font-weight: 700
    }

    .rc-space {
      height: 4px
    }

    #printArea.d-print {
      display: block !important
    }

    @media print {
      :root {
        --print-margin: 5mm;
      }

      @page {
        size: auto;
        margin: var(--print-margin);
      }

      body * {
        visibility: hidden !important
      }

      #printArea,
      #printArea * {
        visibility: visible !important
      }

      #printArea {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: start center;
        padding: 0;
        margin: 0;
        background: transparent;
      }
    }

    /* Modal com scroll confortável */
    .modal-dialog-scrollable .modal-content {
      max-height: 90vh
    }

    .modal-dialog-scrollable .modal-body {
      max-height: calc(90vh - 120px);
      overflow: auto
    }

    @media (max-width: 575.98px) {
      .parts-scroll {
        max-height: 200px
      }

      .selected-scroll {
        max-height: 160px
      }
    }
  </style>
</head>

<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg border-bottom sticky-top bg-body">
    <div class="container-xxl">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <span class="d-inline-grid place-items-center rounded-3 bg-warning text-dark shadow-sm"
          style="width:34px;height:34px;font-size:.7rem"></span>
        <span class="fw-semibold">Rota Motos</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span
          class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Estoque</a></li>
          <li class="nav-item"><a class="nav-link" href="oficina.html">Oficina</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Pedidos</a></li>
          <li class="nav-item"><a class="nav-link" href="financeiro.html">Financeiro</a></li>
        </ul>
        <div class="d-flex gap-2">
          <button id="btnPaper" class="btn btn-outline-secondary" title="Largura do cupom"><i
              class="bi bi-printer"></i></button>
          <button id="btnTema" class="btn btn-outline-secondary"><i class="bi bi-moon-stars"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <main class="container-xxl py-4">
    <!-- KPIs -->
    <section class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-primary-subtle text-primary"><i class="bi bi-bag-check"></i></div>
            <div>
              <div class="small text-body-secondary">Pedidos</div>
              <div id="kpiPedidos" class="h4 mb-0">0</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-success-subtle text-success"><i class="bi bi-cash-stack"></i></div>
            <div>
              <div class="small text-body-secondary">Valor Total</div>
              <div id="kpiValor" class="h4 mb-0">R$ 0,00</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-warning-subtle text-warning"><i class="bi bi-percent"></i></div>
            <div>
              <div class="small text-body-secondary">Descontos</div>
              <div id="kpiDesc" class="h4 mb-0">R$ 0,00</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-info-subtle text-info"><i class="bi bi-graph-up"></i></div>
            <div>
              <div class="small text-body-secondary">Lucro</div>
              <div id="kpiLucro" class="h4 mb-0">R$ 0,00</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filtros + Ações -->
    <section class="card border-0 shadow-sm rounded-xl mb-3">
      <div class="card-header bg-body">
        <div class="d-flex flex-wrap align-items-end gap-2">
          <div class="input-group" style="max-width:360px">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="busca" class="form-control" placeholder="Buscar por cliente, vendedor, NF...">
          </div>
          <div>
            <label class="form-label small mb-1">De</label>
            <input id="de" type="date" class="form-control">
          </div>
          <div>
            <label class="form-label small mb-1">Até</label>
            <input id="ate" type="date" class="form-control">
          </div>
          <div class="ms-auto">
            <button id="btnNovo" class="btn btn-warning text-dark"><i class="bi bi-plus-lg me-1"></i>Cadastrar nova
              venda</button>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>N° Venda</th>
                <th>Cliente</th>
                <th class="text-end">Valor</th>
                <th class="text-end">Desconto</th>
                <th class="text-end">Itens</th>
                <th>Data</th>
                <th>Vendedor</th>
                <th>Status</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal nova/edição de venda (com scroll) -->
  <div class="modal fade" id="vendaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content rounded-xl">
        <form id="formVenda" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="tituloModal">Cadastrar venda</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" id="btnCloseModal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="vendaId">

            <div class="row g-3">
              <div class="col-md-5">
                <label class="form-label">Cliente <span class="text-danger">*</span></label>
                <input id="cliente" class="form-control" required>
                <div class="invalid-feedback">Informe o cliente.</div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Documento</label>
                <div class="input-group">
                  <select id="docTipo" class="form-select" style="max-width:140px">
                    <option>CPF</option>
                    <option>CNPJ</option>
                  </select>
                  <input id="docValor" class="form-control" placeholder="000.000.000-00">
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Vendedor</label>
                <input id="vendedor" class="form-control" placeholder="Quem vendeu?">
              </div>

              <div class="col-md-3">
                <label class="form-label">Data</label>
                <input id="data" type="datetime-local" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Forma de Pagamento</label>
                <select id="pagamento" class="form-select">
                  <option>Dinheiro</option>
                  <option>PIX</option>
                  <option>Cartão de Débito</option>
                  <option>Cartão de Crédito</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="status" class="form-select">
                  <option>OK</option>
                  <option>Pendente Pagamento</option>
                  <option>Separado</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Desconto (R$)</label>
                <input id="desconto" type="number" min="0" step="0.01" value="0" class="form-control">
              </div>

              <!-- Itens do estoque -->
              <div class="col-12">
                <div class="parts-panel">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                      <label class="form-label small mb-1">Buscar item no estoque</label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="buscaItem" class="form-control" placeholder="SKU, nome, local...">
                      </div>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small mb-1">Categoria</label>
                      <select id="filtroCat" class="form-select">
                        <option value="">Todas</option>
                      </select>
                    </div>
                  </div>

                  <div class="parts-scroll mt-3">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="sticky-subhead">
                        <tr class="table-light">
                          <th>SKU</th>
                          <th>Item</th>
                          <th>Categoria</th>
                          <th class="text-end">Preço</th>
                          <th class="text-end">Qtd disp.</th>
                          <th class="text-end">Adicionar</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyEstoque"></tbody>
                    </table>
                  </div>

                  <div class="mt-3">
                    <div class="fw-semibold mb-2">Itens selecionados</div>
                    <div class="selected-scroll">
                      <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                          <tr>
                            <th>SKU</th>
                            <th>Item</th>
                            <th class="text-end">Preço</th>
                            <th class="text-end">Qtd</th>
                            <th class="text-end">Subtotal</th>
                            <th class="text-end">Remover</th>
                          </tr>
                        </thead>
                        <tbody id="tbodySel"></tbody>
                        <tfoot>
                          <tr>
                            <th colspan="4" class="text-end">Subtotal</th>
                            <th class="text-end" id="subtotalTxt">R$ 0,00</th>
                            <th></th>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>

                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Subtotal (R$)</label>
                <input id="subtotal" class="form-control" readonly value="0.00">
              </div>
              <div class="col-md-4">
                <label class="form-label">Total (R$)</label>
                <input id="total" class="form-control" readonly value="0.00">
              </div>
              <div class="col-md-4">
                <label class="form-label">Endereço para cupom</label>
                <input id="endereco" class="form-control" value="Av. Olegário Maciel, 1292">
              </div>

            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal"
              id="btnCancelar">Cancelar</button>
            <button class="btn btn-warning text-dark" type="submit">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Área de impressão (cupom) -->
  <div id="printArea" class="d-none">
    <div class="receipt" id="receipt"></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toasts"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    'use strict';
    // ===== Utils / Tema =====
    const $ = (id) => document.getElementById(id);
    const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const TEMA_KEY = 'estoque_tema';
    function aplicarTema(t) { document.documentElement.setAttribute('data-bs-theme', t); $('btnTema').innerHTML = (t === 'dark') ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon-stars"></i>'; }
    $('btnTema').addEventListener('click', () => { const a = document.documentElement.getAttribute('data-bs-theme') || 'light'; const p = a === 'light' ? 'dark' : 'light'; aplicarTema(p); localStorage.setItem(TEMA_KEY, p); });
    aplicarTema(localStorage.getItem(TEMA_KEY) || 'light');

    function toast(msg, variant = 'success') {
      const map = { success: 'text-bg-success', danger: 'text-bg-danger', warning: 'text-bg-warning text-dark', info: 'text-bg-info' };
      const el = document.createElement('div'); el.className = `toast ${map[variant] || ''}`;
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.getElementById('toasts').appendChild(el);
      const t = new bootstrap.Toast(el, { delay: 2500, autohide: true }); el.addEventListener('hidden.bs.toast', () => el.remove()); t.show();
    }
    const nowDT = () => { const d = new Date(); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); return d.toISOString().slice(0, 16); };
    const fmtDate = (iso) => iso ? new Date(iso).toLocaleString('pt-BR') : '-';
    const genNF = () => { const k = 'orders_seq'; const n = +(localStorage.getItem(k) || 0) + 1; localStorage.setItem(k, n); return String(n).padStart(6, '0'); };

    // ===== Storage =====
    const ESTOQUE_KEY = 'estoque_itens';
    const loadEstoque = () => { try { return JSON.parse(localStorage.getItem(ESTOQUE_KEY) || '[]'); } catch { return []; } };
    const saveEstoque = (a) => localStorage.setItem(ESTOQUE_KEY, JSON.stringify(a));

    const ORD_KEYS = ['orders', 'ORDERS'];
    const loadOrders = () => {
      for (const k of ['orders', 'ORDERS', 'orders_lista', 'vendas_lista', 'pedidos', 'pedidos_lista']) {
        try { const a = JSON.parse(localStorage.getItem(k) || '[]'); if (Array.isArray(a)) return a; } catch { }
      } return [];
    };
    const saveOrders = (arr) => { for (const k of ORD_KEYS) localStorage.setItem(k, JSON.stringify(arr)); };

    let ESTOQUE = loadEstoque();
    let ORDERS = loadOrders();

    // ===== KPIs / Tabela =====
    function statusBadge(s) {
      const map = { 'OK': 'st-ok', 'Pendente Pagamento': 'st-pen', 'Separado': 'st-sep' };
      return `<span class="status-badge ${map[s] || 'st-ok'}">${s}</span>`;
    }
    function calcLucroPedido(p) {
      let margem = 0;
      for (const it of (p.items || [])) {
        const custo = +it.custo || 0;
        margem += ((+it.preco || 0) - custo) * (+it.qtd || 0);
      }
      return margem - (+p.desconto || 0);
    }
    function renderKPIs() {
      $('kpiPedidos').textContent = ORDERS.length;
      const valorTotal = ORDERS.reduce((s, o) => s + (+o.total || 0), 0);
      const descontos = ORDERS.reduce((s, o) => s + (+o.desconto || 0), 0);
      const lucro = ORDERS.reduce((s, o) => s + calcLucroPedido(o), 0);
      $('kpiValor').textContent = fmtBRL.format(valorTotal);
      $('kpiDesc').textContent = fmtBRL.format(descontos);
      $('kpiLucro').textContent = fmtBRL.format(lucro);
    }
    function renderTabela() {
      renderKPIs();
      const q = $('busca').value.trim().toLowerCase();
      const de = $('de').value ? new Date($('de').value) : null;
      const ate = $('ate').value ? new Date($('ate').value) : null;

      const lista = ORDERS.filter(o => {
        const str = [o.id, o.nf, o.cliente, o.vendedor, o.pagamento, o.status].join(' ').toLowerCase();
        if (q && !str.includes(q)) return false;
        const d = o.dataISO ? new Date(o.dataISO) : null;
        if (de && d && d < new Date(de.toDateString())) return false;
        if (ate && d && d > new Date(ate.toDateString() + " 23:59:59")) return false;
        return true;
      });

      const tb = $('tbody'); tb.innerHTML = '';
      if (lista.length === 0) {
        tb.innerHTML = '<tr><td colspan="9" class="text-center py-5 text-body-secondary">Nenhuma venda.</td></tr>';
        return;
      }
      for (const o of lista) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${o.nf || o.id}</td>
        <td>${o.cliente || '-'}</td>
        <td class="text-end">${fmtBRL.format(+o.total || 0)}</td>
        <td class="text-end">${fmtBRL.format(+o.desconto || 0)}</td>
        <td class="text-end">${(o.items || []).reduce((s, i) => s + (+i.qtd || 0), 0)}</td>
        <td>${fmtDate(o.dataISO)}</td>
        <td>${o.vendedor || '-'}</td>
        <td>${statusBadge(o.status || 'OK')}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" data-acao="cupom" data-id="${o.id}" title="Gerar cupom"><i class="bi bi-printer"></i></button>
            <button class="btn btn-outline-warning text-dark" data-acao="editar" data-id="${o.id}" title="Editar"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-outline-danger" data-acao="excluir" data-id="${o.id}" title="Excluir"><i class="bi bi-trash"></i></button>
          </div>
        </td>`;
        tb.appendChild(tr);
      }
    }

    // ===== Modal / Itens =====
    const vendaModalEl = document.getElementById('vendaModal');
    let SNAP_ESTOQUE = null, MODAL_SALVO = false;
    let SEL = []; // itens selecionados {sku,nome,preco,custo?,qtd}

    function categoriasEstoque() { return [...new Set(ESTOQUE.map(i => i.categoria).filter(Boolean))].sort(); }
    function fillCategorias() {
      const sel = $('filtroCat'); const cur = sel.value;
      sel.innerHTML = '<option value="">Todas</option>' + categoriasEstoque().map(c => `<option>${c}</option>`).join('');
      if (cur) sel.value = cur;
    }
    const searchQ = () => $('buscaItem').value.trim().toLowerCase();
    const searchCat = () => $('filtroCat').value;

    function renderEstoque() {
      ESTOQUE = loadEstoque();
      fillCategorias();
      const q = searchQ(), cat = searchCat();
      const list = ESTOQUE.filter(p => {
        const okCat = !cat || p.categoria === cat;
        const okQ = !q || [p.sku, p.nome, p.local].join(' ').toLowerCase().includes(q);
        return okCat && okQ;
      });
      const tb = $('tbodyEstoque'); tb.innerHTML = '';
      if (list.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" class="text-center text-body-secondary">Sem itens.</td></tr>'; return;
      }
      for (const p of list) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${p.sku}</td>
        <td>${p.nome || ''}</td>
        <td>${p.categoria || ''}</td>
        <td class="text-end">${fmtBRL.format(+p.preco || 0)}</td>
        <td class="text-end" id="disp-${p.sku}">${+p.qtd || 0}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <input type="number" min="1" step="1" value="1" class="form-control form-control-sm qty-input" data-qtd-add="${p.sku}">
            <button class="btn btn-outline-primary" data-add="${p.sku}"><i class="bi bi-check2"></i> Selecionar</button>
          </div>
        </td>`;
        tb.appendChild(tr);
      }
    }

    function renderSel() {
      const tb = $('tbodySel'); tb.innerHTML = '';
      if (SEL.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" class="text-center text-body-secondary">Nenhum item selecionado.</td></tr>';
        $('subtotal').value = '0.00'; $('subtotalTxt').textContent = fmtBRL.format(0);
        recalcTotal(); return;
      }
      for (const it of SEL) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${it.sku}</td>
        <td>${it.nome || ''}</td>
        <td class="text-end">${fmtBRL.format(+it.preco || 0)}</td>
        <td class="text-end">
          <input type="number" min="1" step="1" value="${it.qtd || 1}" class="form-control form-control-sm qty-input" data-qtd="${it.sku}">
        </td>
        <td class="text-end">${fmtBRL.format((+it.preco || 0) * (+it.qtd || 1))}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" data-remover="${it.sku}"><i class="bi bi-x-lg"></i></button>
        </td>`;
        tb.appendChild(tr);
      }
      const subtotal = SEL.reduce((s, p) => s + (+p.preco || 0) * (+p.qtd || 0), 0);
      $('subtotal').value = subtotal.toFixed(2);
      $('subtotalTxt').textContent = fmtBRL.format(subtotal);
      recalcTotal();
    }

    function recalcTotal() {
      const sub = parseFloat($('subtotal').value) || 0;
      const desc = parseFloat($('desconto').value) || 0;
      const total = Math.max(0, sub - desc);
      $('total').value = total.toFixed(2);
    }

    function changeStock(sku, delta) {
      const it = ESTOQUE.find(x => x.sku === sku); if (!it) return false;
      it.qtd = Math.max(0, (+it.qtd || 0) + delta);
      saveEstoque(ESTOQUE);
      const cell = document.getElementById(`disp-${CSS.escape(sku)}`); if (cell) cell.textContent = it.qtd;
      return true;
    }

    function addItem(sku) {
      const it = ESTOQUE.find(x => x.sku === sku);
      if (!it) { toast('Item não encontrado.', 'danger'); return; }
      let disp = +it.qtd || 0; if (disp <= 0) { toast('Sem estoque.', 'warning'); return; }
      const inp = document.querySelector(`[data-qtd-add="${CSS.escape(sku)}"]`);
      let qtd = Math.max(1, parseInt(inp?.value || '1', 10));
      if (qtd > disp) { qtd = disp; if (inp) inp.value = qtd; toast('Ajustado ao estoque disponível.', 'warning'); }
      const idx = SEL.findIndex(x => x.sku === sku);
      if (idx >= 0) SEL[idx].qtd += qtd; else SEL.push({ sku: it.sku, nome: it.nome, preco: +it.preco || 0, custo: +it.custo || 0, qtd });
      changeStock(sku, -qtd);
      renderSel();
    }

    document.addEventListener('click', (e) => {
      const add = e.target.closest('[data-add]'); if (add) { addItem(add.dataset.add); return; }
      const rem = e.target.closest('[data-remover]'); if (rem) {
        const sku = rem.dataset.remover;
        const it = SEL.find(x => x.sku === sku);
        if (it) { changeStock(sku, +it.qtd); }
        SEL = SEL.filter(x => x.sku !== sku);
        renderSel();
        return;
      }
      const act = e.target.closest('[data-acao]'); if (!act) return;
      const id = act.dataset.id, ac = act.dataset.acao;
      if (ac === 'excluir') {
        if (!confirm('Excluir esta venda?')) return;
        const o = ORDERS.find(x => x.id === id);
        if (o) { for (const it of (o.items || [])) changeStock(it.sku, +it.qtd); }
        ORDERS = ORDERS.filter(x => x.id !== id); saveOrders(ORDERS); renderTabela(); toast('Venda excluída.', 'danger');
      }
      if (ac === 'editar') { abrirEditar(id); }
      if (ac === 'cupom') { gerarCupom(id); }
    });

    document.addEventListener('input', (e) => {
      if (e.target.id === 'buscaItem') renderEstoque();
      if (e.target.id === 'desconto') recalcTotal();
      const qq = e.target.getAttribute('data-qtd');
      if (qq) {
        const sku = qq; const it = SEL.find(x => x.sku === sku); if (!it) return;
        const novo = Math.max(1, parseInt(e.target.value || '1', 10));
        const delta = novo - it.qtd;
        if (delta > 0) {
          const disp = +(ESTOQUE.find(x => x.sku === sku)?.qtd || 0);
          const pode = Math.min(delta, disp);
          if (pode > 0) { it.qtd += pode; changeStock(sku, -pode); }
          if (pode < delta) { toast('Estoque insuficiente. Ajustado ao máximo.', 'warning'); }
          e.target.value = it.qtd;
        } else if (delta < 0) {
          it.qtd += delta; changeStock(sku, -delta); e.target.value = it.qtd;
        }
        renderSel();
      }
    });
    $('filtroCat').addEventListener('change', renderEstoque);

    // ===== Abrir modal (novo/editar) =====
    function resetForm() {
      $('vendaId').value = '';
      $('cliente').value = ''; $('docTipo').value = 'CPF'; $('docValor').value = '';
      $('vendedor').value = ''; $('data').value = nowDT();
      $('pagamento').value = 'Dinheiro'; $('status').value = 'OK'; $('desconto').value = '0';
      $('endereco').value = 'Av. Olegário Maciel, 1292';
      SEL = [];
      renderEstoque(); renderSel();
    }
    function abrirNovo() {
      $('tituloModal').textContent = 'Cadastrar venda';
      resetForm();
      ESTOQUE = loadEstoque(); SNAP_ESTOQUE = JSON.parse(JSON.stringify(ESTOQUE)); MODAL_SALVO = false;
      bootstrap.Modal.getOrCreateInstance(vendaModalEl).show();
    }
    function abrirEditar(id) {
      const o = ORDERS.find(x => x.id === id); if (!o) return;
      $('tituloModal').textContent = 'Editar venda';
      $('vendaId').value = o.id;
      $('cliente').value = o.cliente || '';
      $('docTipo').value = o.docTipo || 'CPF'; $('docValor').value = o.doc || '';
      $('vendedor').value = o.vendedor || ''; $('data').value = o.dataISO || nowDT();
      $('pagamento').value = o.pagamento || 'Dinheiro'; $('status').value = o.status || 'OK';
      $('desconto').value = (o.desconto != null ? o.desconto : 0);
      $('endereco').value = o.endereco || 'Av. Olegário Maciel, 1292';
      SEL = (o.items || []).map(it => ({ sku: it.sku, nome: it.nome, preco: +it.preco || 0, custo: +it.custo || 0, qtd: +it.qtd || 1 }));
      ESTOQUE = loadEstoque(); SNAP_ESTOQUE = JSON.parse(JSON.stringify(ESTOQUE)); MODAL_SALVO = false;
      renderEstoque(); renderSel();
      bootstrap.Modal.getOrCreateInstance(vendaModalEl).show();
    }
    $('btnNovo').addEventListener('click', abrirNovo);

    // Reverter estoque se fechar sem salvar
    vendaModalEl.addEventListener('hidden.bs.modal', () => {
      if (!MODAL_SALVO && SNAP_ESTOQUE) {
        saveEstoque(SNAP_ESTOQUE); ESTOQUE = loadEstoque();
        SEL = []; renderEstoque(); renderSel();
        toast('Alterações canceladas. Estoque restaurado.', 'info');
      }
    });

    // Salvar venda
    $('formVenda').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target; form.classList.add('was-validated');
      if (!form.checkValidity()) return;
      if (SEL.length === 0) { toast('Adicione pelo menos um item.', 'danger'); return; }

      const subtotal = SEL.reduce((s, p) => s + (+p.preco || 0) * (+p.qtd || 0), 0);
      const desconto = parseFloat($('desconto').value) || 0;
      const total = Math.max(0, subtotal - desconto);

      const obj = {
        id: $('vendaId').value || ('PD-' + Math.random().toString(36).slice(2, 8).toUpperCase()),
        nf: $('vendaId').value ? (ORDERS.find(x => x.id === $('vendaId').value)?.nf || genNF()) : genNF(),
        cliente: $('cliente').value.trim(),
        docTipo: $('docTipo').value,
        doc: $('docValor').value.trim(),
        vendedor: $('vendedor').value.trim(),
        dataISO: $('data').value,
        pagamento: $('pagamento').value,
        status: $('status').value,
        desconto,
        total,
        totalBruto: subtotal,
        endereco: $('endereco').value.trim(),
        items: SEL.map(p => ({ sku: p.sku, nome: p.nome, preco: +p.preco || 0, custo: +p.custo || 0, qtd: +p.qtd || 1 }))
      };

      const idx = ORDERS.findIndex(x => x.id === obj.id);
      if (idx >= 0) ORDERS[idx] = obj; else ORDERS.unshift(obj);
      saveOrders(ORDERS);

      MODAL_SALVO = true;
      bootstrap.Modal.getOrCreateInstance(vendaModalEl).hide();
      renderTabela();
      toast(idx >= 0 ? 'Venda atualizada.' : 'Venda cadastrada.', 'success');
    });

    // ===== Cupom Fiscal (com ITENS COMPRADOS) =====
    function gerarCupom(id) {
      const o = ORDERS.find(x => x.id === id); if (!o) { toast('Pedido não encontrado.', 'danger'); return; }
      const fmt = (n) => fmtBRL.format(n);

      const itens = (o.items || []);
      const itensHTML = itens.length ? itens.map(it => {
        const nome = (it.sku ? '[' + it.sku + '] ' : '') + (it.nome || '');
        const qtd = +it.qtd || 1;
        const pu = +it.preco || 0;
        const sub = pu * qtd;
        return `
        <div>${nome}</div>
        <div class="rc-slim">  ${qtd} x ${fmt(pu)} = <strong>${fmt(sub)}</strong></div>
      `;
      }).join('') : '<div>—</div>';

      const html = `
      <div class="receipt">
        <div class="rc-center rc-title">ROTA MOTOS</div>
        <div class="rc-center rc-slim">CNPJ 60.469.425/0001-76</div>
        <div class="rc-center rc-title rc-slim">Ordem de Compra</div>
        <div class="rc-hr"></div>

        <div class="rc-center rc-title rc-slim">DADOS DO CLIENTE</div>
        <div>Nome Cliente: ${o.cliente || '-'}</div>
        <div>CPF/CNPJ: ${o.doc || '-'}</div>
        <div class="rc-hr"></div>

        <div class="rc-center rc-title rc-slim">DADOS DO VENDEDOR</div>
        <div>Nome Vendedor: ${o.vendedor || '-'}</div>
        <div class="rc-hr"></div>

        <div class="rc-center rc-title rc-slim">DADOS DE COMPRAS</div>
        <div>N° NF: ${o.nf || '-'}</div>
        <div>Data de Compra: ${o.dataISO ? new Date(o.dataISO).toLocaleString('pt-BR') : '-'}</div>
        <div>Endereço: ${o.endereco || 'Av. Olegário Maciel, 1292'}</div>
        <div>Forma de Pagamento: ${o.pagamento || '-'}</div>
        <div>Subtotal: ${fmt(+o.totalBruto || 0)}</div>
        <div>Desconto: ${fmt(+o.desconto || 0)}</div>
        <div class="rc-strong">Valor Total: ${fmt(+o.total || 0)}</div>

        <div class="rc-hr"></div>
        <div class="rc-center rc-title rc-slim">ITENS COMPRADOS</div>
        ${itensHTML}

        <div class="rc-hr"></div>
        <div class="rc-center rc-title rc-slim">OBSERVAÇÕES</div>
        <div class="rc-small">
          Observações: CONFIRA A EMBALAGEM E ITENS ANTES DE ABRIR OU UTILIZAR OS MESMOS! ROTA MOTOS Agradece!
        </div>
        <div class="rc-space"></div>
      </div>
    `;

      $('receipt').innerHTML = html;
      const printHost = $('printArea');
      printHost.classList.remove('d-none'); printHost.classList.add('d-print');
      window.print();
      setTimeout(() => { printHost.classList.add('d-none'); printHost.classList.remove('d-print'); }, 300);
    }

    // ===== Seleção rápida de largura do cupom (qualquer impressora) =====
    function setReceiptWidth(w) {
      document.documentElement.style.setProperty('--receipt-width', w);
      localStorage.setItem('receipt_width', w);
      toast(`Largura do cupom: ${w}`, 'info');
    }
    (function initWidth() {
      const saved = localStorage.getItem('receipt_width');
      if (saved) setReceiptWidth(saved);
    })();
    $('btnPaper').addEventListener('click', () => {
      const cur = getComputedStyle(document.documentElement).getPropertyValue('--receipt-width').trim();
      const w = prompt('Largura do cupom (58mm, 80mm, 100% para A4):', cur || '80mm');
      if (!w) return;
      const ok = /^(58mm|80mm|100%|\d+mm)$/i.test(w.trim());
      setReceiptWidth(ok ? w.trim() : '80mm');
    });

    // ===== Eventos básicos =====
    $('busca').addEventListener('input', renderTabela);
    $('de').addEventListener('change', renderTabela);
    $('ate').addEventListener('change', renderTabela);
    $('filtroCat').addEventListener('change', renderEstoque);

    // ===== Atualizações externas =====
    window.addEventListener('storage', (e) => {
      if (e.key === ESTOQUE_KEY) { ESTOQUE = loadEstoque(); renderEstoque(); }
      if (['orders', 'ORDERS', 'orders_lista', 'vendas_lista', 'pedidos', 'pedidos_lista'].includes(e.key)) { ORDERS = loadOrders(); renderTabela(); }
    });

    // ===== Init =====
    renderTabela();
  </script>
</body>


</html>

