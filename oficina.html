<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rota Motos — Oficina</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{ --ink:#0f172a; --muted:#6b7280; --border:#e6e8ef; --accent:#f59e0b; --nav-h:64px; }
    body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f8fb;color:var(--ink);padding-top:var(--nav-h)}
    .container{max-width:1180px}

    /* NAVBAR */
    .navbar{background:#fff;border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
    .brand .logo{width:32px;height:32px;border-radius:8px;background:#111;color:#fff;display:grid;place-items:center;font-weight:800}
    .nav-link{color:var(--ink);font-weight:600;border-radius:8px;padding:.5rem .75rem}
    .nav-link:hover{background:#f2f4f8}
    .nav-link.active{background:#fff7ed;border:1px solid #fcd34d}

    /* CARDS */
    .card-soft{background:#fff;border:1px solid var(--border);border-radius:12px}
    .metric{display:flex;gap:.8rem;align-items:center;padding:1rem}
    .metric .icon{width:42px;height:42px;border-radius:10px;display:grid;place-items:center;color:#fff}
    .i-repair{background:#64748b}.i-garage{background:#0ea5e9}.i-value{background:#059669}.i-profit{background:#f59e0b}
    .metric .label{color:var(--muted);font-size:.9rem}
    .metric .value{font-weight:800;font-size:1.35rem}

    /* TOOLBAR */
    .toolbar{background:#fff;border:1px solid var(--border);border-left:4px solid var(--accent);border-radius:12px;padding:1rem}
    .input-icon{position:relative}
    .input-icon i{position:absolute;left:.65rem;top:50%;transform:translateY(-50%);color:#9aa1ad}
    .input-icon input{padding-left:2.1rem}
    .form-control,.form-select{border-radius:10px;border-color:var(--border)}
    .form-control:focus,.form-select:focus{box-shadow:0 0 0 .25rem rgba(245,158,11,.16);border-color:#fcd34d}
    .btn-ghost{background:#fff;border:1px solid var(--border);font-weight:600}
    .btn-ghost:hover{background:#f9fafb}
    .btn-primary-clean{background:var(--accent);color:#111;border:1px solid #fbbf24;font-weight:700}

    /* TABELA */
    .table thead th{background:#eef2ff;color:#1e1b4b;font-weight:700;position:sticky;top:0;z-index:2;border-bottom:1px solid #e5e7eb}
    .nowrap{white-space:nowrap}
    .empty{color:#6b7280;text-align:center;padding:2rem 0}
    .badge-status{font-weight:700;border:1px solid #e5e7eb}
    .st-rev{background:#fff7ed;color:#b45309;border-color:#fed7aa}
    .st-agu{background:#f1f5f9;color:#334155}
    .st-conc{background:#ecfdf5;color:#047857;border-color:#a7f3d0}

    /* MODAL – peças & carrinho */
    .parts-panel,.cart-panel{background:#fff;border:1px solid var(--border);border-radius:10px;padding:.75rem}
    .parts-list{max-height:36vh;overflow:auto}
    .cart-list{max-height:48vh;overflow:auto}
    .cart-row{display:flex;align-items:center;justify-content:space-between;gap:.5rem;padding:.45rem .25rem;border-bottom:1px dashed #e5e7eb}
    .cart-row:last-child{border-bottom:0}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand brand" href="#"><span class="logo">RM</span><span>Rota Motos</span></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topnav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="topnav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#">Estoque</a></li>
          <li class="nav-item"><a class="nav-link active" href="#">Oficina</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Vendas</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Financeiro</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- MÉTRICAS -->
    <div class="row g-3 mb-3">
      <div class="col-md-3"><div class="card-soft metric"><div class="icon i-repair"><i class="bi bi-wrench"></i></div><div><div class="label">Consertos</div><div id="mConsertos" class="value">0</div></div></div></div>
      <div class="col-md-3"><div class="card-soft metric"><div class="icon i-garage"><i class="bi bi-bicycle"></i></div><div><div class="label">Motos em Oficina</div><div id="mOficina" class="value">0</div></div></div></div>
      <div class="col-md-3"><div class="card-soft metric"><div class="icon i-value"><i class="bi bi-cash-stack"></i></div><div><div class="label">Valor Total</div><div id="mValor" class="value">R$ 0,00</div></div></div></div>
      <div class="col-md-3"><div class="card-soft metric"><div class="icon i-profit"><i class="bi bi-graph-up"></i></div><div><div class="label">Lucro</div><div id="mLucro" class="value">R$ 0,00</div></div></div></div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar mb-3">
      <div class="row g-3 align-items-center">
        <div class="col-xl-6 col-lg-7">
          <label class="form-label mb-1">&nbsp;</label>
          <div class="input-icon">
            <i class="bi bi-search"></i>
            <input id="search" class="form-control" placeholder="Buscar por cliente, modelo, mecânico, placa...">
          </div>
        </div>
        <div class="col-xl-2 col-lg-3">
          <label class="form-label mb-1">Filtrar por cliente</label>
          <select id="fCliente" class="form-select"><option value="">Todos</option></select>
        </div>
        <div class="col-xl-4 col-lg-12 d-grid d-xl-flex justify-content-xl-end">
          <button id="btnNova" class="btn btn-primary-clean" data-bs-toggle="modal" data-bs-target="#modalOS">
            <i class="bi bi-plus-lg"></i> Adicionar moto
          </button>
        </div>
      </div>
    </div>

    <!-- TABELA -->
    <div class="card-soft p-0">
      <div class="table-responsive" style="max-height:60vh;">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Cliente</th><th>Modelo Moto</th><th class="nowrap">Placa</th>
              <th class="nowrap">Entrada na Oficina</th><th class="nowrap">Saída da Oficina</th>
              <th>Mecânico</th><th>Status</th>
              <th class="text-end nowrap">Valor do Serviço</th>
              <th class="text-end nowrap">Valor Peças</th>
              <th class="text-end nowrap">Total</th>
              <th class="text-end nowrap">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="empty">Nenhum registro.</div>
      </div>
    </div>
  </div>

  <!-- MODAL OS -->
  <div class="modal fade" id="modalOS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="modalTitle">Nova OS</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <!-- Form + Peças -->
            <div class="col-lg-7">
              <form id="formOS" class="row g-3" novalidate>
                <div class="col-md-5"><label class="form-label">Nome Cliente</label><input id="iCliente" class="form-control" required></div>
                <div class="col-md-5"><label class="form-label">Modelo Moto</label><input id="iModelo" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">Placa</label><input id="iPlaca" class="form-control" style="text-transform:uppercase"></div>

                <div class="col-md-4"><label class="form-label">Data de Entrada</label><input id="iEntrada" type="date" class="form-control" required></div>
                <div class="col-md-4"><label class="form-label">Data de Saída</label><input id="iSaida" type="date" class="form-control"></div>
                <div class="col-md-4"><label class="form-label">Mecânico</label><input id="iMecanico" class="form-control"></div>

                <div class="col-md-4">
                  <label class="form-label">Status</label>
                  <select id="iStatus" class="form-select">
                    <option>Revisando</option>
                    <option>Aguardando Cliente</option>
                    <option>Concluído</option>
                  </select>
                </div>

                <div class="col-md-4"><label class="form-label">Valor do Serviço</label><input id="iValor" type="number" step="0.01" class="form-control" value="0"></div>
                <div class="col-md-4"><label class="form-label">Valor Peças (auto)</label><input id="iValorPecas" class="form-control" value="R$ 0,00" disabled></div>

                <!-- Forma de pagamento -->
                <div class="col-md-6">
                  <label class="form-label">Forma de Pagamento</label>
                  <select id="iPagamento" class="form-select">
                    <option>Dinheiro</option>
                    <option>PIX</option>
                    <option>Cartão de Débito</option>
                    <option>Cartão de Crédito</option>
                  </select>
                </div>
              </form>

              <div class="parts-panel mt-1">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <h6 class="m-0">Peças em estoque</h6>
                  <small class="text-secondary">Ao adicionar, o modal não fecha</small>
                </div>
                <div class="row g-2 mb-2">
                  <div class="col-8">
                    <div class="input-icon">
                      <i class="bi bi-search"></i>
                      <input id="pSearch" class="form-control" placeholder="Buscar por SKU, nome, categoria...">
                    </div>
                  </div>
                  <div class="col-4">
                    <select id="pCategoria" class="form-select"><option value="">Todas as categorias</option></select>
                  </div>
                </div>
                <div class="parts-list" id="partsList"></div>
              </div>
            </div>

            <!-- Carrinho -->
            <div class="col-lg-5">
              <div class="cart-panel">
                <h5 class="fw-bold mb-2">Carrinho Rota Motos</h5>
                <div id="cartList" class="cart-list mb-2"></div>
                <div class="d-flex justify-content-between"><span class="text-secondary">Subtotal (peças)</span><strong id="cSubtotal">R$ 0,00</strong></div>
                <div class="d-flex align-items-center justify-content-between mt-2">
                  <label class="text-secondary m-0" for="cDesconto">Desconto</label>
                  <input id="cDesconto" type="number" step="0.01" class="form-control" style="width:140px" value="0">
                </div>
                <div class="d-flex justify-content-between mt-2"><span class="text-secondary">Valor Total</span><strong id="cTotal">R$ 0,00</strong></div>
                <div class="d-grid mt-3"><button id="btnSalvarOS" class="btn btn-primary-clean" type="button">Salvar OS</button></div>
              </div>
            </div>
          </div>
        </div><!-- body -->
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    /* ===== Helpers ===== */
    const BRL = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
    const $ = id => document.getElementById(id);
    const money = n => BRL.format(+n||0);
    const todayISO = () => { const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); };
    const safeId = s => String(s).replace(/[^a-zA-Z0-9_-]/g,"_");
    const priceOf = it => +it.preco || 0;                 // SEMPRE PREÇO
    const itemTotal = it => priceOf(it) * (+it.qtd||0);

    // Ajuste navbar fixa
    function fitNav(){ const nav=document.querySelector(".navbar.fixed-top"); if(nav) document.documentElement.style.setProperty("--nav-h", nav.offsetHeight+"px"); }
    addEventListener("resize", fitNav); document.addEventListener("DOMContentLoaded", fitNav);

    /* ===== Impressão (Thermal 80mm) via IFRAME invisível ===== */
    // Config padrão p/ Tomate MDK-080: bobina 80mm, largura útil ~72mm
    const PRINTER = { widthMM: 80, innerMM: 72, marginMM: 0, fontPX: 12, linePX: 18 };

    function buildReceiptInDoc(d, j){
      // Reset
      d.head.innerHTML = ""; d.body.innerHTML = "";
      d.body.style.margin="0"; d.body.style.padding="0";
      d.documentElement.style.background="white";

      const css = `
        @page { size: ${PRINTER.widthMM}mm auto; margin: ${PRINTER.marginMM}mm; }
        * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        html, body { width: ${PRINTER.widthMM}mm; }
        body { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: ${PRINTER.fontPX}px; line-height: ${PRINTER.linePX}px; color:#000; }
        .wrap { width: ${PRINTER.innerMM}mm; margin: 0 auto; }
        .ctr { text-align:center }
        .sep { text-align:center; letter-spacing:.5px; }
        .mt { margin-top: 6px }
        .blk { break-inside: avoid; page-break-inside: avoid; }
      `;
      const style = d.createElement("style");
      style.textContent = css;
      d.head.appendChild(style);

      const wrap = d.createElement("div");
      wrap.className = "wrap blk";
      d.body.appendChild(wrap);

      const nf = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
      const total = (+j.valor||0)+(+j.subtotal||0)-(+j.desconto||0);

      function line(text, cls){
        const el = d.createElement("div");
        el.textContent = String(text==null?"":text);
        if(cls) el.className = cls + " blk";
        wrap.appendChild(el);
      }
      function sep(){ line("-----------------------------------------------","sep"); }

      // Cabeçalho
      line("Rota Motos","ctr");
      line("CNPJ 60.469.425/0001-76","ctr");
      line("Ordem de Compra","ctr");
      sep();

      // Cliente
      line("Dados do Cliente","ctr mt");
      line("Nome Cliente: " + (j.cliente||"-"));
      line("Moto Cliente: " + (j.modelo||"-"));
      line("Placa da moto: " + (j.placa||"-"));
      line("Entrada: " + (j.entrada||"-"));
      sep();

      // Mecânico
      line("Dados do Mecânico","ctr mt");
      line("Nome Mecânico: " + (j.mecanico||"-"));
      sep();

      // Itens
      line("Dados de Compras","ctr mt");
      if(Array.isArray(j.pecas) && j.pecas.length){
        j.pecas.forEach((p,i)=>{
          line("Item " + (i+1) + ": " + p.nome + " (Qtd: " + p.qtd + ")");
        });
      }else{
        line("Sem itens.");
      }
      line("Forma de Pagamento: " + (j.pagamento||"-"));
      line("Subtotal peças: " + nf.format(+j.subtotal||0)); // soma com PREÇO
      line("Descontos: " + nf.format(+j.desconto||0));
      line("Valor Total: " + nf.format(total));
      sep();

      line("Observações","ctr mt");
      line("Observações: CONFIRA A EMBALAGEM E ITENS ANTES DE ABRIR OU UTILIZAR OS MESMOS! ROTA MOTOS Agradece!");
    }

    function printReceiptInline(j){
      const iframe = document.createElement("iframe");
      iframe.style.position="fixed"; iframe.style.right="0"; iframe.style.bottom="0";
      iframe.style.width="0"; iframe.style.height="0"; iframe.style.border="0";
      iframe.setAttribute("aria-hidden","true");
      document.body.appendChild(iframe);

      iframe.onload = function(){
        const d = iframe.contentDocument || iframe.contentWindow.document;
        buildReceiptInDoc(d, j);
        // dá um tick para o layout estabilizar
        setTimeout(function(){
          try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){}
          // remove o iframe após a fila de impressão
          setTimeout(()=> iframe.remove(), 1200);
        }, 60);
      };

      // Garantir carga do documento
      try{ iframe.src = "about:blank"; }catch(e){
        const d = iframe.contentDocument || iframe.contentWindow.document;
        d.open(); d.close();
        iframe.onload && iframe.onload();
      }
    }

    /* ===== Estoque (localStorage) ===== */
    const STOCK_KEYS=["estoque.ui.v2","estoque.clean.color.v1","estoque.clean.v1","estoque.visualclean.v1","estoque"];
    function loadStock(){
      for(const k of STOCK_KEYS){
        try{ const raw=localStorage.getItem(k); if(raw){ const arr=JSON.parse(raw)||[]; return {key:k, items:Array.isArray(arr)?arr:[]}; } }
        catch(e){}
      }
      return {key:null, items:[]};
    }
    function saveStock(key,items){ if(key) localStorage.setItem(key, JSON.stringify(items)); }
    let estoque = loadStock();
    estoque.items = (estoque.items||[]).map(it=>({
      sku:String(it.sku??""), nome:String(it.nome??""), categoria:String(it.categoria??""),
      qtd:Number(it.qtd??0), alerta:Number(it.alerta??0), preco:Number(it.preco??0),
      custo:Number(it.custo??0), local:String(it.local??"")
    }));

    /* ===== OS (localStorage) ===== */
    const OS_KEY="oficina.jobs.v1";
    let jobs = (()=>{ try{ const j=JSON.parse(localStorage.getItem(OS_KEY)); return Array.isArray(j)?j:[]; }catch(e){ return []; } })();
    const saveJobs = ()=> localStorage.setItem(OS_KEY, JSON.stringify(jobs));

    /* ===== Estado ===== */
    let editingId=null, cart=[];

    /* ===== Render UI ===== */
    function badge(s){
      if(s==="Concluído") return '<span class="badge badge-status st-conc">Concluído</span>';
      if(s==="Aguardando Cliente") return '<span class="badge badge-status st-agu">Aguardando</span>';
      return '<span class="badge badge-status st-rev">Revisando</span>';
    }
    function filterRows(list){
      const q=($("search").value||"").toLowerCase(), fc=$("fCliente").value;
      return list.filter(r=>{
        const mQ=!q||[r.cliente,r.modelo,r.mecanico,r.placa,r.status].join(" ").toLowerCase().includes(q);
        const mC=!fc||r.cliente===fc; return mQ && mC;
      });
    }
    function rebuildClientFilter(){
      const sel=$("fCliente"); const set=[...new Set(jobs.map(j=>j.cliente).filter(Boolean))].sort();
      sel.innerHTML='<option value="">Todos</option>'+set.map(c=>"<option>"+c+"</option>").join("");
    }
    function renderTable(){
      const data=filterRows(jobs);
      const total=data.reduce((s,j)=> s+(+j.valor||0)+(+j.subtotal||0)-(+j.desconto||0),0);
      const valorPecas=data.reduce((s,j)=> s+(+j.subtotal||0),0);
      const emOficina=data.filter(j=>j.status!=="Concluído").length;
      $("mConsertos").textContent=data.length; $("mOficina").textContent=emOficina;
      $("mValor").textContent=money(total);
      $("mLucro").textContent=money(total-valorPecas);
      const tbody=$("tbody"), empty=$("empty");
      if(!data.length){ tbody.innerHTML=""; empty.style.display="block"; return; }
      empty.style.display="none";
      tbody.innerHTML=data.map(j=>
        '<tr>'+
          '<td>'+(j.cliente||"")+'</td>'+
          '<td>'+(j.modelo||"")+'</td>'+
          '<td class="nowrap">'+(j.placa||"")+'</td>'+
          '<td class="nowrap">'+(j.entrada||"")+'</td>'+
          '<td class="nowrap">'+(j.saida||"")+'</td>'+
          '<td>'+(j.mecanico||"")+'</td>'+
          '<td>'+badge(j.status)+'</td>'+
          '<td class="text-end nowrap">'+money(+j.valor||0)+'</td>'+
          '<td class="text-end nowrap">'+money(+j.subtotal||0)+'</td>'+
          '<td class="text-end nowrap">'+money((+j.valor||0)+(+j.subtotal||0)-(+j.desconto||0))+'</td>'+
          '<td class="text-end nowrap">'+
            '<div class="btn-group btn-group-sm">'+
              '<button class="btn btn-outline-secondary" data-action="print" data-id="'+j.id+'" title="Imprimir SO"><i class="bi bi-printer"></i></button>'+
              '<button class="btn btn-outline-secondary" data-action="edit" data-id="'+j.id+'" title="Editar"><i class="bi bi-pencil-square"></i></button>'+
              '<button class="btn btn-outline-danger"    data-action="del"  data-id="'+j.id+'" title="Excluir"><i class="bi bi-trash"></i></button>'+
            '</div>'+
          '</td>'+
        '</tr>'
      ).join("");
    }

    /* ===== Peças (modal) ===== */
    function rebuildPartCats(){
      const sel=$("pCategoria"); const cats=[...new Set(estoque.items.map(i=>i.categoria).filter(Boolean))].sort();
      sel.innerHTML='<option value="">Todas as categorias</option>'+cats.map(c=>"<option>"+c+"</option>").join("");
    }
    function renderParts(){
      const q=($("pSearch").value||"").toLowerCase(), cat=$("pCategoria").value;
      const reserved=new Map(cart.map(x=>[x.sku,x.qtd]));
      const items=estoque.items.filter(it=>{
        const mQ=!q||[it.sku,it.nome,it.categoria].join(" ").toLowerCase().includes(q);
        const mC=!cat || (it.categoria||"")===cat; return mQ&&mC;
      }).slice(0,80);

      $("partsList").innerHTML = items.map(it=>{
        const disp=Math.max(0,(+it.qtd||0)-(reserved.get(it.sku)||0));
        const qid="q_"+safeId(it.sku);
        const precoExib = +it.preco||0;
        return '<div class="d-flex align-items-center justify-content-between py-1 border-bottom">'+
          '<div class="small">'+
            '<div class="fw-semibold">'+(it.nome||"")+'</div>'+
            '<div class="text-secondary">SKU: '+(it.sku||"")+' • Cat: '+(it.categoria||"-")+' • Em estoque: <strong>'+disp+'</strong> • Preço: <strong>'+money(precoExib)+'</strong></div>'+
          '</div>'+
          '<div class="d-flex align-items-center gap-2">'+
            '<input id="'+qid+'" type="number" min="1" step="1" value="1" class="form-control form-control-sm" style="width:80px">'+
            '<button class="btn btn-ghost btn-sm" data-action="addPart" data-sku="'+encodeURIComponent(it.sku)+'" data-qid="'+qid+'"><i class="bi bi-plus-lg"></i> Adicionar</button>'+
          '</div>'+
        '</div>';
      }).join("") || '<div class="text-secondary text-center py-3">Nada encontrado…</div>';
    }

    /* ===== Carrinho ===== */
    function renderCart(){
      $("cartList").innerHTML = cart.map((it,i)=>
        '<div class="cart-row">'+
          '<div class="small"><div class="fw-semibold">'+it.nome+'</div><div class="text-secondary">SKU: '+it.sku+' • Preço: '+money(priceOf(it))+'</div></div>'+
          '<div class="d-flex align-items-center gap-2">'+
            '<input class="form-control form-control-sm" type="number" min="1" step="1" value="'+it.qtd+'" style="width:64px" data-action="changeQty" data-idx="'+i+'">'+
            '<div class="text-end" style="width:110px">'+money(itemTotal(it))+'</div>'+
            '<button class="btn btn-outline-danger btn-sm" data-action="removePart" data-idx="'+i+'"><i class="bi bi-x-lg"></i></button>'+
          '</div>'+
        '</div>'
      ).join("") || '<div class="text-secondary text-center py-3">Carrinho vazio…</div>';

      const subtotal=cart.reduce((s,x)=>s+itemTotal(x),0); // soma de PREÇOS
      $("cSubtotal").textContent=money(subtotal);
      $("iValorPecas").value=money(subtotal);
      const total=(+$("iValor").value||0)+subtotal-(+$("cDesconto").value||0);
      $("cTotal").textContent=money(Math.max(0,total));
    }

    /* ===== Modal helpers ===== */
    function resetModal(){
      editingId=null; cart=[]; $("formOS").reset();
      $("iEntrada").value=todayISO(); $("iStatus").value="Revisando"; $("cDesconto").value=0; $("iPagamento").value="Dinheiro";
      estoque = loadStock();
      estoque.items = (estoque.items||[]).map(it=>({ sku:String(it.sku??""), nome:String(it.nome??""), categoria:String(it.categoria??""), qtd:Number(it.qtd??0), alerta:Number(it.alerta??0), preco:Number(it.preco??0), custo:Number(it.custo??0), local:String(it.local??"") }));
      rebuildPartCats(); renderParts(); renderCart();
    }

    /* ===== Eventos ===== */

    // Abrir modal
    $("btnNova").addEventListener("click", resetModal);

    // Filtros / busca
    $("search").addEventListener("input", renderTable);
    $("fCliente").addEventListener("change", renderTable);
    $("pSearch").addEventListener("input", renderParts);
    $("pCategoria").addEventListener("change", renderParts);
    $("cDesconto").addEventListener("input", renderCart);
    $("iValor").addEventListener("input", renderCart);

    // Lista de peças (delegação)
    $("partsList").addEventListener("click", function(ev){
      const btn=ev.target.closest("[data-action='addPart']"); if(!btn) return;
      const sku=decodeURIComponent(btn.dataset.sku), qid=btn.dataset.qid;
      const it=estoque.items.find(x=>x.sku===sku); if(!it){ alert("Peça não encontrada no estoque."); return; }
      let q=Math.max(1, parseInt((document.getElementById(qid)||{}).value||"1",10));
      const reserved=cart.find(x=>x.sku===sku)?.qtd||0;
      const disp=Math.max(0,(+it.qtd||0)-reserved);
      if(q>disp) q=disp;
      if(q<=0){ alert("Sem quantidade disponível."); return; }
      const i=cart.findIndex(x=>x.sku===sku);
      if(i>=0) cart[i].qtd+=q;
      else cart.push({sku, nome:it.nome, preco:+it.preco||0, qtd:q}); // usa PREÇO
      renderCart(); renderParts();
    });

    // Carrinho (delegação)
    $("cartList").addEventListener("input", function(ev){
      if(ev.target.dataset.action!=="changeQty") return;
      const i=+ev.target.dataset.idx;
      let q=Math.max(1, parseInt(ev.target.value||"1",10));
      const sku=cart[i].sku, stock=+(estoque.items.find(x=>x.sku===sku)?.qtd||0);
      const others=cart.filter((_,idx)=>idx!==i && _.sku===sku).reduce((s,x)=>s+x.qtd,0);
      const disp=Math.max(0, stock-others);
      if(q>disp) q=disp;
      cart[i].qtd=q; renderCart(); renderParts();
    });
    $("cartList").addEventListener("click", function(ev){
      const btn=ev.target.closest("[data-action='removePart']"); if(!btn) return;
      cart.splice(+btn.dataset.idx,1); renderCart(); renderParts();
    });

    // Salvar OS
    $("btnSalvarOS").addEventListener("click", function(){
      if(!$("formOS").reportValidity()){ $("formOS").classList.add("was-validated"); return; }

      const job={
        id: editingId || String(Date.now()),
        cliente:$("iCliente").value.trim(),
        modelo:$("iModelo").value.trim(),
        placa:$("iPlaca").value.trim().toUpperCase(),
        entrada:$("iEntrada").value, saida:$("iSaida").value,
        mecanico:$("iMecanico").value.trim(),
        status:$("iStatus").value,
        valor:+$("iValor").value||0,
        desconto:+$("cDesconto").value||0,
        pagamento:$("iPagamento").value,
        pecas:cart.map(x=>({sku:x.sku,nome:x.nome,preco:+x.preco||0,qtd:+x.qtd||0})),
        subtotal:cart.reduce((s,x)=>s+itemTotal(x),0) // soma PREÇO
      };

      // Atualiza estoque (consumo/rollback em edição)
      const old=jobs.find(j=>j.id===job.id);
      const before=new Map((old?.pecas||[]).map(p=>[p.sku,p.qtd]));
      const after=new Map(job.pecas.map(p=>[p.sku,p.qtd]));
      const map=new Map(estoque.items.map(it=>[it.sku,it]));
      const skus=new Set([].concat(Array.from(before.keys()), Array.from(after.keys())));
      skus.forEach(function(sku){
        const delta=(after.get(sku)||0)-(before.get(sku)||0); // >0 consome
        const it=map.get(sku); if(it){ it.qtd=(+it.qtd||0)-delta; if(it.qtd<0) it.qtd=0; }
      });
      estoque.items=[].concat(Array.from(map.values())); saveStock(estoque.key, estoque.items);

      if(old){ const i=jobs.findIndex(j=>j.id===job.id); jobs[i]=job; } else jobs.push(job);
      saveJobs(); rebuildClientFilter(); renderTable();

      bootstrap.Modal.getInstance(document.getElementById("modalOS"))?.hide();
      resetModal();
    });

    // Ações da tabela (editar / excluir / imprimir)
    $("tbody").addEventListener("click", function(ev){
      const btn=ev.target.closest("[data-action]"); if(!btn) return;
      const id=btn.dataset.id, act=btn.dataset.action;

      if(act==="edit"){
        const j=jobs.find(x=>x.id===id); if(!j) return;
        editingId=j.id; $("modalTitle").textContent="Editar OS";
        $("iCliente").value=j.cliente||""; $("iModelo").value=j.modelo||""; $("iPlaca").value=j.placa||"";
        $("iEntrada").value=j.entrada||todayISO(); $("iSaida").value=j.saida||""; $("iMecanico").value=j.mecanico||"";
        $("iStatus").value=j.status||"Revisando"; $("iValor").value=+j.valor||0; $("cDesconto").value=+j.desconto||0;
        $("iPagamento").value = j.pagamento || "Dinheiro";
        cart=(j.pecas||[]).map(p=>({sku:p.sku,nome:p.nome,preco:+p.preco||0,qtd:+p.qtd||0}));
        renderCart(); rebuildPartCats(); renderParts();
        new bootstrap.Modal(document.getElementById("modalOS")).show();
      }

      if(act==="del"){
        if(!confirm("Excluir esta OS?")) return;
        const j=jobs.find(x=>x.id===id); if(!j) return;
        const map=new Map(estoque.items.map(it=>[it.sku,it]));
        (j.pecas||[]).forEach(p=>{ const it=map.get(p.sku); if(it){ it.qtd=(+it.qtd||0)+(+p.qtd||0); }});
        estoque.items=[].concat(Array.from(map.values())); saveStock(estoque.key, estoque.items);
        jobs=jobs.filter(x=>x.id!==id); saveJobs(); rebuildClientFilter(); renderTable();
      }

      if(act==="print"){
        const j = jobs.find(x=>x.id===id); if(!j) return;
        printReceiptInline(j); // imprime via IFRAME com @page 80mm
      }
    });

    /* ===== Init ===== */
    (function init(){
      rebuildClientFilter(); renderTable(); rebuildPartCats(); renderParts(); $("iEntrada").value=todayISO();
    })();
  })();
  </script>
</body>
</html>
