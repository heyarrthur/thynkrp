<!doctype html>
<html lang="pt-BR" data-bs-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rota Motos | Financeiro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/app.css">

  <!-- ...conteúdo... -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/print.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    .rounded-xl {
      border-radius: 1rem
    }

    .table td,
    .table th {
      vertical-align: middle
    }

    .icon-wrap {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: grid;
      place-items: center
    }

    .card-graph canvas {
      max-height: 340px
    }

    @media (max-width: 575.98px) {
      .kpi h4 {
        font-size: 1.15rem
      }
    }
  </style>
</head>

<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg border-bottom sticky-top bg-body">
    <div class="container-xxl">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <span class="d-inline-grid place-items-center rounded-3 bg-warning text-dark shadow-sm"
          style="width:34px;height:34px;font-size:.7rem"></span>
        <span class="fw-semibold">Rota Motos</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span
          class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Estoque</a></li>
          <li class="nav-item"><a class="nav-link" href="oficina.html">Oficina</a></li>
          <li class="nav-item"><a class="nav-link" href="pedidos.html">Pedidos</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Financeiro</a></li>
        </ul>
        <button id="btnTema" class="btn btn-outline-secondary"><i class="bi bi-moon-stars"></i></button>
      </div>
    </div>
  </nav>

  <main class="container-xxl py-4">
    <!-- KPIs -->
    <section class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl kpi">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-success-subtle text-success"><i class="bi bi-cash-stack"></i></div>
            <div>
              <div class="small text-body-secondary">Valor Bruto</div>
              <h4 id="kpiBruto" class="mb-0">R$ 0,00</h4>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl kpi">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-primary-subtle text-primary"><i class="bi bi-wallet2"></i></div>
            <div>
              <div class="small text-body-secondary">Valor Líquido</div>
              <h4 id="kpiLiquido" class="mb-0">R$ 0,00</h4>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl kpi">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-danger-subtle text-danger"><i class="bi bi-arrow-down-circle"></i></div>
            <div>
              <div class="small text-body-secondary">Despesas</div>
              <h4 id="kpiDespesas" class="mb-0">R$ 0,00</h4>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm rounded-xl kpi">
          <div class="card-body d-flex gap-3 align-items-center">
            <div class="icon-wrap bg-warning-subtle text-warning"><i class="bi bi-percent"></i></div>
            <div>
              <div class="small text-body-secondary">Descontos</div>
              <h4 id="kpiDescontos" class="mb-0">R$ 0,00</h4>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filtro de mês + Ações -->
    <section class="d-flex flex-wrap align-items-end gap-2 mb-3">
      <div>
        <label class="form-label small mb-1">Mês</label>
        <select id="selMes" class="form-select">
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>
      <div class="ms-auto d-flex flex-wrap gap-2">
        <button id="btnAddEntrada" class="btn btn-success"><i class="bi bi-plus-circle me-1"></i>Adicionar
          Entrada</button>
        <button id="btnAddSaida" class="btn btn-danger"><i class="bi bi-dash-circle me-1"></i>Adicionar Saída</button>
        <button id="btnAddDespesa" class="btn btn-outline-danger"><i class="bi bi-receipt me-1"></i>Adicionar
          Despesas</button>
        <button id="btnFechar" class="btn btn-warning text-dark"><i class="bi bi-clipboard-check me-1"></i>Fechar o
          Mês</button>
      </div>
    </section>

    <!-- Histórico + Pizza -->
    <section class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm rounded-xl h-100">
          <div class="card-header bg-body d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Histórico do mês</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Data</th>
                    <th>Tipo</th>
                    <th>Descrição</th>
                    <th class="text-end">Valor</th>
                  </tr>
                </thead>
                <tbody id="tbodyHist"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm rounded-xl h-100 card-graph">
          <div class="card-header bg-body">
            <h6 class="mb-0">Resumo do mês</h6>
          </div>
          <div class="card-body">
            <canvas id="pizza" height="220"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Linha -->
    <section class="card border-0 shadow-sm rounded-xl mt-3 card-graph">
      <div class="card-header bg-body">
        <h6 class="mb-0">Entradas x Saídas (por dia)</h6>
      </div>
      <div class="card-body">
        <canvas id="linha" height="260"></canvas>
      </div>
    </section>
  </main>

  <!-- Modal Entrada -->
  <div class="modal fade" id="entradaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-scrollable">
      <div class="modal-content rounded-xl">
        <form id="formEntrada" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Adicionar Entrada</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label">Tipo de Entrada</label>
                <select id="e_tipo" class="form-select">
                  <option>Dinheiro Próprio</option>
                  <option>Venda Fora da Loja</option>
                  <option>Outros</option>
                </select>
              </div>
              <div class="col-sm-6">
                <label class="form-label">Quem deu entrada?</label>
                <input id="e_pessoa" class="form-control">
              </div>
              <div class="col-sm-6">
                <label class="form-label">Dia da Entrada</label>
                <input id="e_data" type="date" class="form-control" required>
              </div>
              <div class="col-sm-6">
                <label class="form-label">Valor (R$) <span class="text-danger">*</span></label>
                <input id="e_valor" type="number" step="0.01" min="0" required class="form-control">
                <div class="invalid-feedback">Informe o valor.</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-success" type="submit">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Saída -->
  <div class="modal fade" id="saidaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-scrollable">
      <div class="modal-content rounded-xl">
        <form id="formSaida" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Adicionar Saída</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label">Tipo de Saída</label>
                <select id="s_tipo" class="form-select">
                  <option>Uso próprio</option>
                  <option>Investimentos</option>
                  <option>Itens para loja</option>
                  <option>Outros</option>
                </select>
              </div>
              <div class="col-sm-6">
                <label class="form-label">Quem deu saída?</label>
                <input id="s_pessoa" class="form-control">
              </div>
              <div class="col-sm-6">
                <label class="form-label">Dia da Saída</label>
                <input id="s_data" type="date" class="form-control" required>
              </div>
              <div class="col-sm-6">
                <label class="form-label">Valor (R$) <span class="text-danger">*</span></label>
                <input id="s_valor" type="number" step="0.01" min="0" required class="form-control">
                <div class="invalid-feedback">Informe o valor.</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-danger" type="submit">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Despesa -->
  <div class="modal fade" id="despesaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-scrollable">
      <div class="modal-content rounded-xl">
        <form id="formDespesa" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Adicionar Despesa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label">Categoria</label>
                <select id="d_cat" class="form-select">
                  <option>Água</option>
                  <option>Luz</option>
                  <option>Internet</option>
                  <option>Aluguel</option>
                  <option>Folha</option>
                  <option>Outros</option>
                </select>
              </div>
              <div class="col-sm-6">
                <label class="form-label">Data</label>
                <input id="d_data" type="date" class="form-control" required>
              </div>
              <div class="col-sm-12">
                <label class="form-label">Observação (opcional)</label>
                <input id="d_obs" class="form-control" placeholder="Ex.: Ref. Agosto/2025">
              </div>
              <div class="col-sm-6">
                <label class="form-label">Valor (R$) <span class="text-danger">*</span></label>
                <input id="d_valor" type="number" step="0.01" min="0" required class="form-control">
                <div class="invalid-feedback">Informe o valor.</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-outline-danger" type="submit">Salvar despesa</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Fechar Mês -->
  <div class="modal fade" id="fecharModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md">
      <div class="modal-content rounded-xl">
        <div class="modal-header">
          <h5 class="modal-title">Fechar o Mês</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="fecharMsg" class="alert" role="alert"></div>
          <p class="small mb-0 text-body-secondary">Esta janela se fechará automaticamente em 5 segundos.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toasts"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    'use strict';

    // ===== Utils / Tema =====
    const $ = (id) => document.getElementById(id);
    const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const TEMA_KEY = 'estoque_tema';
    const K_ENTRADAS = 'fin_entradas', K_SAIDAS = 'fin_saidas', K_MES = 'fin_mes_selecionado';

    function aplicarTema(t) { document.documentElement.setAttribute('data-bs-theme', t); $('btnTema').innerHTML = (t === 'dark') ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon-stars"></i>'; }
    $('btnTema').addEventListener('click', () => { const a = document.documentElement.getAttribute('data-bs-theme') || 'light'; const p = a === 'light' ? 'dark' : 'light'; aplicarTema(p); localStorage.setItem(TEMA_KEY, p); });
    aplicarTema(localStorage.getItem(TEMA_KEY) || 'light');

    function toast(msg, variant = 'success') {
      const el = document.createElement('div');
      el.className = `toast ${variant === 'danger' ? 'text-bg-danger' : variant === 'warning' ? 'text-bg-warning text-dark' : variant === 'info' ? 'text-bg-info' : 'text-bg-success'}`;
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.getElementById('toasts').appendChild(el);
      const t = new bootstrap.Toast(el, { delay: 2500, autohide: true }); el.addEventListener('hidden.bs.toast', () => el.remove()); t.show();
    }
    const modal = (id) => bootstrap.Modal.getOrCreateInstance(document.getElementById(id));

    // ===== Storage helpers =====
    const load = (k) => { try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch { return []; } };
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    let ENTRADAS = load(K_ENTRADAS);
    let SAIDAS = load(K_SAIDAS);

    // ===== Integração com outras páginas =====
    function loadOrders() {
      const keys = ['ORDERS', 'orders', 'orders_lista', 'vendas_lista', 'pedidos', 'pedidos_lista'];
      for (const k of keys) {
        try { const arr = JSON.parse(localStorage.getItem(k) || '[]'); if (Array.isArray(arr)) return arr; } catch { }
      }
      return [];
    }
    function loadOficina() {
      try { const a = JSON.parse(localStorage.getItem('oficina_lista') || '[]'); return Array.isArray(a) ? a : []; } catch { return []; }
    }

    // ===== Seleção de mês (persistente) =====
    const hoje = new Date();
    const mesSalvo = localStorage.getItem(K_MES);
    $('selMes').value = mesSalvo !== null ? mesSalvo : String(hoje.getMonth());
    $('selMes').addEventListener('change', () => { localStorage.setItem(K_MES, $('selMes').value); renderAll(); });

    function isSameMonth(iso, m, y) {
      if (!iso) return false;
      const d = new Date(iso);
      return d.getMonth() === m && d.getFullYear() === y;
    }
    const num = (n) => { const v = parseFloat(n); return isNaN(v) ? 0 : v; };

    // ===== Cálculos =====
    function calcResumo(mes, ano) {
      const ord = loadOrders();
      const ofi = loadOficina();

      // Vendas
      let vendasBrutas = 0, descontos = 0;
      for (const o of ord) {
        const data = o.dataISO || o.data || o.dataVenda || o.data_venda;
        if (!isSameMonth(data, mes, ano)) continue;

        let bruto = 0;
        const itens = Array.isArray(o.items) ? o.items : (Array.isArray(o.itens) ? o.itens : []);
        if (itens.length) { bruto = itens.reduce((s, it) => s + num(it.preco || it.precoUnit || it.preco_unit) * num(it.qtd || it.quantidade || 1), 0); }
        if (typeof o.totalBruto === 'number') bruto = num(o.totalBruto);
        if (typeof o.total === 'number') bruto = num(o.total);
        if (typeof o.valor === 'number') bruto = num(o.valor);
        vendasBrutas += bruto;
        descontos += num(o.desconto ?? o.desc ?? 0);
      }

      // Oficina
      let servicosBrutos = 0;
      for (const r of ofi) {
        const d = r.saida || r.entrada; if (!isSameMonth(d, mes, ano)) continue;
        servicosBrutos += num(r.valor || 0);
      }

      // Entradas / Saídas desta página
      const eMes = ENTRADAS.filter(e => isSameMonth(e.data, mes, ano));
      const sMes = SAIDAS.filter(s => isSameMonth(s.data, mes, ano));
      const entradasValor = eMes.reduce((s, e) => s + num(e.valor), 0);
      const despesasValor = sMes.reduce((s, e) => s + num(e.valor), 0);

      const bruto = vendasBrutas + servicosBrutos + entradasValor;
      const liquido = bruto - descontos - despesasValor;

      return {
        bruto, liquido, despesas: despesasValor, descontos,
        vendasBrutas, servicosBrutos, entradasValor, eMes, sMes
      };
    }

    // ===== Histórico =====
    function renderHistorico(mes, ano, resumo) {
      const rows = [];
      const mesNome = document.getElementById('selMes').options[mes].textContent;

      if (resumo.vendasBrutas > 0) rows.push({ data: `${mesNome}/${ano}`, tipo: 'Vendas', desc: 'Vendas do mês', valor: resumo.vendasBrutas });
      if (resumo.servicosBrutos > 0) rows.push({ data: `${mesNome}/${ano}`, tipo: 'Manutenções', desc: 'Serviços de oficina', valor: resumo.servicosBrutos });
      if (resumo.entradasValor > 0) rows.push({ data: `${mesNome}/${ano}`, tipo: 'Entradas', desc: 'Entradas extras', valor: resumo.entradasValor });
      if (resumo.descontos > 0) rows.push({ data: `${mesNome}/${ano}`, tipo: 'Descontos', desc: 'Descontos em vendas', valor: -resumo.descontos });
      if (resumo.despesas > 0) rows.push({ data: `${mesNome}/${ano}`, tipo: 'Despesas', desc: 'Saídas/contas do mês', valor: -resumo.despesas });

      for (const e of resumo.eMes) { rows.push({ data: new Date(e.data).toLocaleDateString('pt-BR'), tipo: `Entrada • ${e.tipo}`, desc: e.pessoa || '-', valor: num(e.valor) }); }
      for (const s of resumo.sMes) { rows.push({ data: new Date(s.data).toLocaleDateString('pt-BR'), tipo: `Saída • ${s.tipo}`, desc: s.pessoa || s.obs || '-', valor: -num(s.valor) }); }

      const tb = $('tbodyHist'); tb.innerHTML = '';
      if (rows.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-body-secondary">Sem movimentos neste mês.</td></tr>';
        return;
      }
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.data}</td><td>${r.tipo}</td><td>${r.desc}</td><td class="text-end ${r.valor < 0 ? 'text-danger' : ''}">${fmtBRL.format(r.valor)}</td>`;
        tb.appendChild(tr);
      }
    }

    // ===== Gráficos =====
    let pizzaChart = null, linhaChart = null;
    const fmtMoeda = (v) => fmtBRL.format(v);

    function updatePizza(resumo) {
      const ctx = document.getElementById('pizza');
      if (pizzaChart) pizzaChart.destroy();
      pizzaChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Valor Bruto', 'Valor Líquido', 'Despesas', 'Descontos'],
          datasets: [{
            data: [resumo.bruto, resumo.liquido, resumo.despesas, resumo.descontos],
            backgroundColor: ['#16a34a', '#2563eb', '#ef4444', '#f59e0b'],
            borderWidth: 1
          }]
        },
        options: {
          cutout: '60%',
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${fmtMoeda(ctx.parsed)}` } }
          }
        }
      });
    }

    function daysInMonth(m, y) { return new Date(y, m + 1, 0).getDate(); }

    function makeGradient(ctx, color) {
      const g = ctx.createLinearGradient(0, 0, 0, 260);
      g.addColorStop(0, color + 'cc'); // ~80% opacidade
      g.addColorStop(1, color + '10');
      return g;
    }

    function updateLinha(mes, ano) {
      const ord = loadOrders(), ofi = loadOficina();
      const dias = daysInMonth(mes, ano);
      const labels = [...Array(dias)].map((_, i) => String(i + 1).padStart(2, '0'));
      const entradas = new Array(dias).fill(0);
      const saidas = new Array(dias).fill(0);

      // Entradas
      for (const o of ord) {
        const dIso = o.dataISO || o.data || o.dataVenda || o.data_venda; if (!isSameMonth(dIso, mes, ano)) continue;
        const d = new Date(dIso).getDate() - 1;
        let bruto = 0;
        const itens = Array.isArray(o.items) ? o.items : (Array.isArray(o.itens) ? o.itens : []);
        if (itens.length) { bruto = itens.reduce((s, it) => s + num(it.preco || it.precoUnit || it.preco_unit) * num(it.qtd || it.quantidade || 1), 0); }
        if (typeof o.totalBruto === 'number') bruto = num(o.totalBruto);
        if (typeof o.total === 'number') bruto = num(o.total);
        if (typeof o.valor === 'number') bruto = num(o.valor);
        entradas[d] += bruto;
        saidas[d] += num(o.desconto ?? o.desc ?? 0);
      }
      for (const r of ofi) {
        const di = r.saida || r.entrada; if (!isSameMonth(di, mes, ano)) continue;
        const d = new Date(di).getDate() - 1;
        entradas[d] += num(r.valor || 0);
      }
      for (const e of ENTRADAS.filter(e => isSameMonth(e.data, mes, ano))) {
        const d = new Date(e.data).getDate() - 1; entradas[d] += num(e.valor);
      }
      for (const s of SAIDAS.filter(s => isSameMonth(s.data, mes, ano))) {
        const d = new Date(s.data).getDate() - 1; saidas[d] += num(s.valor);
      }

      const lctx = document.getElementById('linha').getContext('2d');
      if (linhaChart) linhaChart.destroy();
      linhaChart = new Chart(lctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Entradas', data: entradas, borderColor: '#2563eb', backgroundColor: makeGradient(lctx, '#2563eb'), fill: true, tension: .25, pointRadius: 3, borderWidth: 2 },
            { label: 'Saídas (despesas + descontos)', data: saidas, borderColor: '#ef4444', backgroundColor: makeGradient(lctx, '#ef4444'), fill: true, tension: .25, pointRadius: 3, borderWidth: 2 }
          ]
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${fmtMoeda(ctx.parsed.y)}` } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { callback: (v) => fmtMoeda(v) } }
          }
        }
      });
    }

    // ===== KPIs =====
    function renderKPIs(res) {
      $('kpiBruto').textContent = fmtMoeda(res.bruto);
      $('kpiLiquido').textContent = fmtMoeda(res.liquido);
      $('kpiDespesas').textContent = fmtMoeda(res.despesas);
      $('kpiDescontos').textContent = fmtMoeda(res.descontos);
    }

    // ===== Render geral =====
    function renderAll() {
      const mes = +document.getElementById('selMes').value;
      const ano = (new Date()).getFullYear();
      const res = calcResumo(mes, ano);
      renderKPIs(res);
      renderHistorico(mes, ano, res);
      updatePizza(res);
      updateLinha(mes, ano);
    }

    // ===== Entradas / Saídas / Despesas =====
    function todayISO() { const d = new Date(); return d.toISOString().slice(0, 10); }

    document.getElementById('btnAddEntrada').addEventListener('click', () => {
      document.getElementById('e_tipo').value = 'Dinheiro Próprio';
      document.getElementById('e_pessoa').value = '';
      document.getElementById('e_data').value = todayISO();
      document.getElementById('e_valor').value = '';
      modal('entradaModal').show();
    });
    document.getElementById('btnAddSaida').addEventListener('click', () => {
      document.getElementById('s_tipo').value = 'Uso próprio';
      document.getElementById('s_pessoa').value = '';
      document.getElementById('s_data').value = todayISO();
      document.getElementById('s_valor').value = '';
      modal('saidaModal').show();
    });
    document.getElementById('btnAddDespesa').addEventListener('click', () => {
      document.getElementById('d_cat').value = 'Água';
      document.getElementById('d_data').value = todayISO();
      document.getElementById('d_valor').value = '';
      document.getElementById('d_obs').value = '';
      modal('despesaModal').show();
    });

    document.getElementById('formEntrada').addEventListener('submit', (e) => {
      e.preventDefault();
      const f = e.target; f.classList.add('was-validated'); if (!f.checkValidity()) return;
      ENTRADAS.unshift({
        id: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2),
        tipo: document.getElementById('e_tipo').value,
        pessoa: document.getElementById('e_pessoa').value.trim(),
        data: document.getElementById('e_data').value,
        valor: parseFloat(document.getElementById('e_valor').value) || 0
      });
      save(K_ENTRADAS, ENTRADAS); modal('entradaModal').hide(); renderAll(); toast('Entrada registrada.', 'success');
    });

    document.getElementById('formSaida').addEventListener('submit', (e) => {
      e.preventDefault();
      const f = e.target; f.classList.add('was-validated'); if (!f.checkValidity()) return;
      SAIDAS.unshift({
        id: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2),
        tipo: document.getElementById('s_tipo').value,
        pessoa: document.getElementById('s_pessoa').value.trim(),
        data: document.getElementById('s_data').value,
        valor: parseFloat(document.getElementById('s_valor').value) || 0
      });
      save(K_SAIDAS, SAIDAS); modal('saidaModal').hide(); renderAll(); toast('Saída registrada.', 'danger');
    });

    document.getElementById('formDespesa').addEventListener('submit', (e) => {
      e.preventDefault();
      const f = e.target; f.classList.add('was-validated'); if (!f.checkValidity()) return;
      SAIDAS.unshift({
        id: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2),
        tipo: 'Despesa • ' + document.getElementById('d_cat').value,
        obs: document.getElementById('d_obs').value.trim(),
        data: document.getElementById('d_data').value,
        valor: parseFloat(document.getElementById('d_valor').value) || 0
      });
      save(K_SAIDAS, SAIDAS); modal('despesaModal').hide(); renderAll(); toast('Despesa adicionada.', 'warning');
    });

    // ===== Fechar mês (corrigido) =====
    document.getElementById('btnFechar').addEventListener('click', () => {
      const mes = +document.getElementById('selMes').value, ano = (new Date()).getFullYear();
      const res = calcResumo(mes, ano);
      const prevMes = (mes - 1 + 12) % 12, prevAno = mes === 0 ? ano - 1 : ano;
      const prev = calcResumo(prevMes, prevAno);
      const base = prev.liquido || 0;
      const delta = base === 0 ? (res.liquido > 0 ? 100 : 0) : ((res.liquido - base) / base) * 100;

      const box = document.getElementById('fecharMsg');
      box.className = 'alert ' + (delta >= 0 ? 'alert-success' : 'alert-danger');
      box.textContent = delta >= 0
        ? `Esse mês você teve um aumento de ${delta.toFixed(2)}% comparado ao mês passado.`
        : `Esse mês você teve uma queda de ${Math.abs(delta).toFixed(2)}% comparado ao mês passado.`;

      const m = modal('fecharModal'); m.show();
      setTimeout(() => m.hide(), 5000);
    });

    // ===== Atualizações externas (outras abas) =====
    window.addEventListener('storage', (e) => {
      if ([K_ENTRADAS, K_SAIDAS, 'oficina_lista', 'ORDERS', 'orders', 'orders_lista', 'vendas_lista', 'pedidos', 'pedidos_lista'].includes(e.key)) {
        ENTRADAS = load(K_ENTRADAS); SAIDAS = load(K_SAIDAS); renderAll();
      }
    });

    // ===== Init =====
    renderAll();
  </script>
</body>

</html>