<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rota Motos — Financeiro</title>

  <!-- Bootstrap + Icons + Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- jsPDF + AutoTable (para exportar PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{ --ink:#0f172a; --muted:#6b7280; --border:#e6e8ef; --accent:#f59e0b; --nav-h:64px }
    body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f8fb;color:var(--ink);padding-top:var(--nav-h)}
    .container{max-width:1180px}

    /* NAVBAR */
    .navbar{background:#fff;border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
    .brand .logo{width:32px;height:32px;border-radius:8px;background:#111;color:#fff;display:grid;place-items:center;font-weight:800}
    .nav-link{color:var(--ink);font-weight:600;border-radius:8px;padding:.5rem .75rem}
    .nav-link:hover{background:#f2f4f8}
    .nav-link.active{background:#fff7ed;border:1px solid #fcd34d}

    /* CARDS */
    .card-soft{background:#fff;border:1px solid var(--border);border-radius:12px}
    .metric{display:flex;gap:.8rem;align-items:center;padding:1rem}
    .metric .icon{width:42px;height:42px;border-radius:10px;display:grid;place-items:center;color:#fff}
    .i-balance{background:#0ea5e9}.i-in{background:#059669}.i-out{background:#ef4444}
    .metric .label{color:var(--muted);font-size:.9rem}
    .metric .value{font-weight:800;font-size:1.35rem}

    /* TOOLBAR */
    .toolbar{background:#fff;border:1px solid var(--border);border-left:4px solid var(--accent);border-radius:12px;padding:1rem}
    .form-control,.form-select{border-radius:10px;border-color:var(--border)}
    .form-control:focus,.form-select:focus{box-shadow:0 0 0 .25rem rgba(245,158,11,.16);border-color:#fcd34d}
    .btn-ghost{background:#fff;border:1px solid var(--border);font-weight:600}
    .btn-ghost:hover{background:#f9fafb}
    .btn-primary-clean{background:var(--accent);color:#111;border:1px solid #fbbf24;font-weight:700}

    /* CHARTS + TABLE */
    .chart-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:1rem;height:100%}
    .table thead th{background:#eef2ff;color:#1e1b4b;font-weight:700;position:sticky;top:0;z-index:2;border-bottom:1px solid #e5e7eb}
    .nowrap{white-space:nowrap}
    .empty{color:#6b7280;text-align:center;padding:2rem 0}
    .neg{color:#b91c1c}
    .pos{color:#047857}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand brand" href="#"><span class="logo">RM</span><span>Rota Motos</span></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topnav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="topnav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Estoque</a></li>
          <li class="nav-item"><a class="nav-link" href="oficina.html">Oficina</a></li>
          <li class="nav-item"><a class="nav-link" href="vendas.html">Vendas</a></li>
          <li class="nav-item"><a class="nav-link active" href="financeiro.html">Financeiro</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container py-4">

    <!-- MÉTRICAS -->
    <div class="row g-3 mb-3">
      <div class="col-md-4"><div class="card-soft metric"><div class="icon i-balance"><i class="bi bi-coin"></i></div><div><div class="label">Saldo no período</div><div id="mSaldo" class="value">R$ 0,00</div></div></div></div>
      <div class="col-md-4"><div class="card-soft metric"><div class="icon i-in"><i class="bi bi-arrow-down-circle"></i></div><div><div class="label">Entradas</div><div id="mEntradas" class="value">R$ 0,00</div></div></div></div>
      <div class="col-md-4"><div class="card-soft metric"><div class="icon i-out"><i class="bi bi-arrow-up-circle"></i></div><div><div class="label">Saídas</div><div id="mSaidas" class="value">R$ 0,00</div></div></div></div>
    </div>

    <!-- CONTROLES -->
    <div class="toolbar mb-3">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label mb-1">Data inicial</label>
          <input id="fIni" type="date" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Data final</label>
          <input id="fFim" type="date" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Status dos pedidos</label>
          <select id="fStatus" class="form-select">
            <option value="conc">Somente “Concluído”</option>
            <option value="all">Todos (qualquer status)</option>
          </select>
        </div>
        <div class="col-md-3 d-grid d-md-flex gap-2 justify-content-md-end">
          <button id="btnAdd" class="btn btn-primary-clean" data-bs-toggle="modal" data-bs-target="#modalMov"><i class="bi bi-plus-lg"></i> Adicionar movimento</button>
          <button id="btnAtualizar" class="btn btn-ghost"><i class="bi bi-arrow-repeat"></i> Atualizar</button>
          <!-- NOVO: Exportar PDF -->
          <button id="btnExportPDF" class="btn btn-ghost"><i class="bi bi-filetype-pdf"></i> Exportar PDF</button>
        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="row g-3 mb-3">
      <div class="col-lg-4"><div class="chart-card"><h6 class="fw-bold">Entradas por Origem</h6><canvas id="chOrigem"></canvas></div></div>
      <div class="col-lg-4"><div class="chart-card"><h6 class="fw-bold">Entradas por Pagamento</h6><canvas id="chPagamento"></canvas></div></div>
      <div class="col-lg-4"><div class="chart-card"><h6 class="fw-bold">Saídas por Categoria</h6><canvas id="chSaidas"></canvas></div></div>
    </div>

    <!-- TABELA -->
    <div class="card-soft p-0">
      <div class="table-responsive" style="max-height:60vh;">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th class="nowrap">Data</th>
              <th>Tipo</th>
              <th>Origem/Categoria</th>
              <th>Descrição</th>
              <th>Pagamento</th>
              <th class="text-end nowrap">Valor</th>
              <th class="text-end nowrap">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="empty">Nenhuma movimentação no período.</div>
      </div>
    </div>
  </div>

  <!-- MODAL MOVIMENTO -->
  <div class="modal fade" id="modalMov" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title fw-bold">Novo movimento</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="formMov" class="row g-3" novalidate>
            <div class="col-6">
              <label class="form-label">Tipo</label>
              <select id="mvTipo" class="form-select" required>
                <option value="entrada">Entrada</option>
                <option value="saida">Saída</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Data</label>
              <input id="mvData" type="date" class="form-control" required>
            </div>
            <div class="col-6">
              <label class="form-label">Categoria</label>
              <select id="mvCat" class="form-select">
                <option>Outras Entradas</option>
                <option>Aluguel</option>
                <option>Água/Luz</option>
                <option>Salários</option>
                <option>Impostos</option>
                <option>Compras de Estoque</option>
                <option>Outras Saídas</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Forma de Pagamento</label>
              <select id="mvPag" class="form-select">
                <option>Dinheiro</option>
                <option>PIX</option>
                <option>Cartão de Débito</option>
                <option>Cartão de Crédito</option>
                <option>Outro</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Descrição</label>
              <input id="mvDesc" class="form-control" placeholder="Ex: Aluguel de agosto / Ajuste manual">
            </div>
            <div class="col-6">
              <label class="form-label">Valor</label>
              <input id="mvValor" type="number" step="0.01" min="0" class="form-control" required>
            </div>
            <div class="col-6 d-grid align-items-end">
              <button id="btnSalvarMov" type="button" class="btn btn-primary-clean">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    /* ===== Helpers ===== */
    const BRL = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
    const $ = id => document.getElementById(id);
    const money = n => BRL.format(+n||0);
    const todayISO = () => { const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); };
    const clampDate = s => (s||"").slice(0,10);
    function fitNav(){ const nav=document.querySelector(".navbar.fixed-top"); if(nav) document.documentElement.style.setProperty("--nav-h", nav.offsetHeight+"px"); }
    addEventListener("resize", fitNav); document.addEventListener("DOMContentLoaded", fitNav);

    /* ===== Data sources (localStorage) ===== */
    // Vendas: usa preço; se faltar, cai para custo (como na página Vendas)
    const SALE_KEY = "vendas.orders.v1";
    function loadVendas(){
      try{ const arr = JSON.parse(localStorage.getItem(SALE_KEY))||[]; return Array.isArray(arr)?arr:[]; }catch(e){ return []; }
    }
    function totalPedido(p){
      const items = Array.isArray(p.items)?p.items:[];
      const subtotal = items.reduce((s,x)=> s + ((+x.preco>0?+x.preco:+x.custo)||0) * (+x.qtd||0), 0);
      return Math.max(0, subtotal - (+p.desconto||0));
    }

    // Oficina: usa SEMPRE preço (nunca custo)
    const OS_KEY = "oficina.jobs.v1";
    function loadOS(){
      try{ const arr = JSON.parse(localStorage.getItem(OS_KEY))||[]; return Array.isArray(arr)?arr:[]; }catch(e){ return []; }
    }
    function totalOS(j){
      const pecas = Array.isArray(j.pecas)?j.pecas:[];
      const subtotal = ("subtotal" in j) ? (+j.subtotal||0) : pecas.reduce((s,x)=> s + ((+x.preco||0) * (+x.qtd||0)), 0);
      return Math.max(0, (+j.valor||0) + subtotal - (+j.desconto||0));
    }

    // Movimentos extras
    const MOV_KEY = "finance.movs.v1";
    let extraMovs = (()=>{ try{ const arr = JSON.parse(localStorage.getItem(MOV_KEY))||[]; return Array.isArray(arr)?arr:[]; }catch(e){ return []; } })();
    const saveMovs = ()=> localStorage.setItem(MOV_KEY, JSON.stringify(extraMovs));

    /* ===== Filtros ===== */
    $("fIni").value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0,10);
    $("fFim").value = todayISO();
    $("fStatus").value = "conc";

    /* ===== Build unified movements ===== */
    function buildMovements(){
      const ini = clampDate($("fIni").value);
      const fim = clampDate($("fFim").value);
      const onlyConc = $("fStatus").value === "conc";

      const vend = loadVendas().filter(p => {
        const d = clampDate(p.data); if(ini && d < ini) return false; if(fim && d > fim) return false;
        return (!onlyConc) || (p.status === "Concluído");
      }).map(p => ({
        id: "v-"+p.id, fonte: "Vendas", tipo: "entrada",
        data: clampDate(p.data)||todayISO(),
        categoria: "Vendas",
        descricao: "Pedido de " + (p.cliente||"-"),
        pagamento: p.pagamento || "Outro",
        valor: totalPedido(p),
        _isDerived: true
      }));

      const jobs = loadOS().filter(j => {
        const d = clampDate(j.entrada); if(ini && d < ini) return false; if(fim && d > fim) return false;
        return (!onlyConc) || (j.status === "Concluído");
      }).map(j => ({
        id: "o-"+j.id, fonte: "Oficina", tipo: "entrada",
        data: clampDate(j.entrada)||todayISO(),
        categoria: "Oficina",
        descricao: "OS de " + (j.cliente||"-") + (j.modelo?(" ("+j.modelo+")"):""),
        pagamento: j.pagamento || "Outro",
        valor: totalOS(j),
        _isDerived: true
      }));

      const extras = extraMovs.filter(m=>{
        const d = clampDate(m.data); if(ini && d < ini) return false; if(fim && d > fim) return false;
        return true;
      }).map(m=>({
        id: m.id, fonte: m.tipo==="entrada"?"Extras (Entrada)":"Extras (Saída)",
        tipo: m.tipo, data: clampDate(m.data), categoria: m.categoria||"",
        descricao: m.descricao||"", pagamento: m.pagamento||"Outro", valor: +m.valor||0,
        _isDerived: false
      }));

      return [...vend, ...jobs, ...extras].sort((a,b)=> (a.data>b.data?1:-1));
    }

    /* ===== Métricas / Tabela ===== */
    function render(){
      const rows = buildMovements();
      const entradas = rows.filter(r=>r.tipo==="entrada").reduce((s,r)=>s+r.valor,0);
      const saidas   = rows.filter(r=>r.tipo==="saida").reduce((s,r)=>s+r.valor,0);
      const saldo = entradas - saidas;

      $("mEntradas").textContent = money(entradas);
      $("mSaidas").textContent   = money(saidas);
      $("mSaldo").textContent    = money(saldo);

      // tabela
      const tbody=$("tbody"), empty=$("empty");
      if(!rows.length){ tbody.innerHTML=""; empty.style.display="block"; } else {
        empty.style.display="none";
        tbody.innerHTML = rows.map(r=>(
          "<tr>"+
            '<td class="nowrap">'+(r.data||"")+"</td>"+
            "<td>"+(r.tipo==="entrada"?"Entrada":"Saída")+"</td>"+
            "<td>"+(r.categoria||r.fonte||"")+"</td>"+
            "<td>"+(r.descricao||"")+"</td>"+
            "<td>"+(r.pagamento||"")+"</td>"+
            '<td class="text-end nowrap '+(r.tipo==="saida"?"neg":"pos")+'">'+(r.tipo==="saida"?"- ":"")+money(r.valor)+"</td>"+
            '<td class="text-end nowrap">'+(
              r._isDerived
                ? '<span class="text-secondary small">—</span>'
                : '<button class="btn btn-sm btn-outline-danger" data-action="del" data-id="'+r.id+'"><i class="bi bi-trash"></i></button>'
            )+'</td>'+
          "</tr>"
        )).join("");
      }

      // charts
      updateCharts(rows);
    }

    /* ===== Charts (Pie/Donut) ===== */
    let ch1, ch2, ch3;
    function destroyChart(c){ if(c){ try{ c.destroy(); }catch(e){} } }
    function sumBy(rows, fnKey, filterFn){
      const map=new Map();
      rows.filter(filterFn||(()=>true)).forEach(r=>{
        const k = fnKey(r) || "Outro";
        map.set(k, (map.get(k)||0) + r.valor);
      });
      return map;
    }
    function updateCharts(rows){
      // 1) Entradas por origem
      const ent = rows.filter(r=>r.tipo==="entrada");
      const byOrig = sumBy(ent, r=> (r.fonte==="Vendas"?"Vendas": (r.fonte==="Oficina"?"Oficina":"Extras")));
      const labels1 = Array.from(byOrig.keys());
      const data1 = Array.from(byOrig.values());

      // 2) Entradas por pagamento
      const byPay = sumBy(ent, r=> r.pagamento||"Outro");
      const labels2 = Array.from(byPay.keys());
      const data2 = Array.from(byPay.values());

      // 3) Saídas por categoria
      const sai = rows.filter(r=>r.tipo==="saida");
      const byCat = sumBy(sai, r=> r.categoria||"Outras Saídas");
      const labels3 = Array.from(byCat.keys());
      const data3 = Array.from(byCat.values());

      const opt = { responsive:true, plugins:{ legend:{ position:"bottom" } }, cutout:"60%" };

      destroyChart(ch1); destroyChart(ch2); destroyChart(ch3);
      ch1 = new Chart($("chOrigem"), { type:"doughnut", data:{ labels:labels1, datasets:[{ data:data1 }] }, options:opt });
      ch2 = new Chart($("chPagamento"), { type:"doughnut", data:{ labels:labels2, datasets:[{ data:data2 }] }, options:opt });
      ch3 = new Chart($("chSaidas"),   { type:"doughnut", data:{ labels:labels3, datasets:[{ data:data3 }] }, options:opt });
    }

    /* ===== Exportar PDF (entradas e saídas) ===== */
    function exportPDF(){
      const rows = buildMovements();
      const ent = rows.filter(r=>r.tipo==="entrada").reduce((s,r)=>s+r.valor,0);
      const sai = rows.filter(r=>r.tipo==="saida").reduce((s,r)=>s+r.valor,0);
      const saldo = ent - sai;

      const dtIni = clampDate($("fIni").value) || "—";
      const dtFim = clampDate($("fFim").value) || "—";
      const statusTxt = $("fStatus").value==="conc" ? "Somente Concluído" : "Todos";

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});

      // Cabeçalho
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text("Rota Motos — Financeiro (Entradas e Saídas)", 40, 40);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text("Gerado em: " + new Date().toLocaleString('pt-BR'), 40, 58);
      doc.text(`Período: ${dtIni} a ${dtFim} • Status: ${statusTxt}`, 40, 72);

      // Tabela
      const head = [['Data','Tipo','Origem/Categoria','Descrição','Pagamento','Valor']];
      const body = rows.map(r=>[
        r.data || '',
        r.tipo==='entrada'?'Entrada':'Saída',
        r.categoria || r.fonte || '',
        r.descricao || '',
        r.pagamento || '',
        (r.tipo==='saida' ? '- ' : '') + new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(r.valor||0)
      ]);

      doc.autoTable({
        head, body,
        startY: 88,
        styles: { font:'helvetica', fontSize:9, cellPadding:4, overflow:'linebreak' },
        headStyles: { fillColor:[238,242,255], textColor:[30,27,75] },
        columnStyles: {
          0:{cellWidth:70},
          1:{cellWidth:70},
          2:{cellWidth:160},
          3:{cellWidth:260},
          4:{cellWidth:110},
          5:{halign:'right', cellWidth:110}
        },
        didParseCell: function(dataCell){
          if(dataCell.section==='body' && dataCell.column.index===5){
            const row = rows[dataCell.row.index];
            if(row.tipo==='saida'){
              dataCell.cell.styles.textColor = [185,28,28]; // vermelho
            } else {
              dataCell.cell.styles.textColor = [4,120,87];  // verde
            }
          }
        }
      });

      // Resumo
      const y = doc.lastAutoTable.finalY + 18;
      doc.setFont('helvetica','bold'); doc.setFontSize(11);
      doc.text('Resumo', 40, y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(`Entradas:  ${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(ent)}`, 40, y+18);
      doc.text(`Saídas:    ${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(sai)}`, 40, y+34);
      doc.text(`Saldo:     ${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(saldo)}`, 40, y+50);

      // Nome do arquivo
      const fname = `financeiro_${dtIni}_a_${dtFim}.pdf`.replace(/[^a-zA-Z0-9_.-]/g,'_');
      doc.save(fname);
    }

    /* ===== Modal movimentos extras ===== */
    function resetModal(){
      $("formMov").reset();
      $("mvTipo").value="entrada";
      $("mvData").value=todayISO();
      $("mvCat").value="Outras Entradas";
      $("mvPag").value="Dinheiro";
      $("mvValor").value="";
      $("mvDesc").value="";
    }
    $("btnAdd").addEventListener("click", resetModal);

    $("btnSalvarMov").addEventListener("click", function(){
      if(!$("formMov").reportValidity()){ $("formMov").classList.add("was-validated"); return; }
      const mov = {
        id: "m-"+Date.now(),
        tipo: $("mvTipo").value,
        data: $("mvData").value,
        categoria: $("mvCat").value,
        descricao: $("mvDesc").value.trim(),
        pagamento: $("mvPag").value,
        valor: +$("mvValor").value || 0
      };
      extraMovs.push(mov); saveMovs();
      bootstrap.Modal.getInstance(document.getElementById("modalMov"))?.hide();
      render();
    });

    // excluir movimento manual
    $("tbody").addEventListener("click", function(ev){
      const btn = ev.target.closest("[data-action='del']"); if(!btn) return;
      const id = btn.dataset.id;
      if(!confirm("Excluir este movimento?")) return;
      extraMovs = extraMovs.filter(m=>m.id!==id); saveMovs(); render();
    });

    // filtros
    $("btnAtualizar").addEventListener("click", render);
    $("fIni").addEventListener("change", render);
    $("fFim").addEventListener("change", render);
    $("fStatus").addEventListener("change", render);

    // Exportar PDF
    $("btnExportPDF").addEventListener("click", exportPDF);

    /* ===== Init ===== */
    (function init(){
      document.documentElement.style.setProperty("--nav-h", (document.querySelector(".navbar.fixed-top")?.offsetHeight||64)+"px");
      $("mvData").value=todayISO();
      render();
    })();
  })();
  </script>
</body>
</html>
