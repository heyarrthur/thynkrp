<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rota Motos — Vendas</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{--ink:#0f172a;--muted:#6b7280;--border:#e6e8ef;--accent:#f59e0b;--nav-h:64px}
*{box-sizing:border-box}
body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f8fb;color:var(--ink);padding-top:var(--nav-h)}
.container{max-width:1180px}
.navbar{background:#fff;border-bottom:1px solid var(--border)}
.brand{display:flex;gap:.5rem;align-items:center;font-weight:800}
.brand .logo{width:32px;height:32px;border-radius:8px;background:#111;color:#fff;display:grid;place-items:center}
.nav-link{color:var(--ink);font-weight:600;border-radius:8px}
.nav-link.active{background:#fff7ed;border:1px solid #fcd34d}

.card-soft{background:#fff;border:1px solid var(--border);border-radius:12px}
.metric{display:flex;gap:.8rem;align-items:center;padding:1rem}
.metric .icon{width:42px;height:42px;border-radius:10px;display:grid;place-items:center;color:#fff}
.i-orders{background:#64748b}.i-await{background:#0ea5e9}.i-total{background:#10b981}
.metric .label{color:var(--muted);font-size:.9rem}
.metric .value{font-weight:800;font-size:1.35rem}

.toolbar{background:#fff;border:1px solid var(--border);border-left:4px solid var(--accent);border-radius:12px;padding:1rem}
.form-control,.form-select{border-radius:10px;border-color:var(--border)}
.form-control:focus,.form-select:focus{box-shadow:0 0 0 .25rem rgba(245,158,11,.16);border-color:#fcd34d}
.btn-ghost{background:#fff;border:1px solid var(--border);font-weight:600}
.btn-ghost:hover{background:#f9fafb}
.btn-primary-clean{background:var(--accent);color:#111;border:1px solid #fbbf24;font-weight:700}

.table thead th{background:#eef2ff;color:#1e1b4b;font-weight:700}
.empty{color:#6b7280;text-align:center;padding:2rem 0}

/* Status badges */
.status-badge{display:inline-flex;align-items:center;gap:.35rem;padding:.28rem .68rem;border-radius:999px;font-weight:800;font-size:.78rem}
.status-badge i{font-size:.95rem}
.st-aguardando{color:#b45309;background:#fff7ed;border:1px solid #fde68a}
.st-separado{color:#1d4ed8;background:#eaf1ff;border:1px solid #bfdbfe}
.st-concluido{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0}
.st-cancelado{color:#991b1b;background:#fef2f2;border:1px solid #fecaca}

/* Modal */
.modal-lg{--bs-modal-width: 1000px}
.parts-panel{border-right:1px dashed var(--border)}
.part-card{border:1px solid var(--border);border-radius:10px;padding:.6rem;margin-bottom:.6rem}
.badge-soft{background:#f1f5f9;border:1px solid #e2e8f0;color:#334155;border-radius:999px;padding:.15rem .5rem;font-weight:700;font-size:.72rem}
.cart-item{border-bottom:1px dashed #e5e7eb;padding:.35rem 0}
.totals{background:#fafafa;border:1px dashed #e5e7eb;border-radius:10px;padding:.6rem}
.right-num{text-align:right}
.mono{font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace}

/* Avisos */
#lsWarn{display:none}
</style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a class="navbar-brand brand" href="#"><span class="logo">RM</span>Rota Motos</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#topnav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="topnav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Estoque</a></li>
        <li class="nav-item"><a class="nav-link" href="oficina.html">Oficina</a></li>
        <li class="nav-item"><a class="nav-link active" href="vendas.html">Vendas</a></li>
        <li class="nav-item"><a class="nav-link" href="financeiro.html">Financeiro</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container py-4">

  <!-- Aviso localStorage -->
  <div id="lsWarn" class="alert alert-danger border-0 shadow-sm" role="alert">
    ⚠️ Não foi possível acessar o armazenamento do navegador. Ative cookies/armazenamento do site
    ou abra esta página via <strong>https://seu-usuario.github.io/</strong>. Sem isso, as vendas não serão salvas.
  </div>

  <!-- Métricas -->
  <div class="row g-3 mb-3">
    <div class="col-md-4"><div class="card-soft metric"><div class="icon i-orders"><i class="bi bi-receipt"></i></div><div><div class="label">Pedidos</div><div id="mPedidos" class="value">0</div></div></div></div>
    <div class="col-md-4"><div class="card-soft metric"><div class="icon i-await"><i class="bi bi-hourglass-split"></i></div><div><div class="label">Aguardando Pagto</div><div id="mAguardando" class="value">0</div></div></div></div>
    <div class="col-md-4"><div class="card-soft metric"><div class="icon i-total"><i class="bi bi-currency-dollar"></i></div><div><div class="label">Total Vendido</div><div id="mTotal" class="value">R$ 0,00</div></div></div></div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-lg-5">
        <label class="form-label mb-1">Buscar</label>
        <input id="search" class="form-control" placeholder="cliente, vendedor, documento...">
      </div>
      <div class="col-md-3">
        <label class="form-label mb-1">Status</label>
        <select id="fStatus" class="form-select">
          <option value="">Todos</option>
          <option>Aguardando Pagamento</option>
          <option>Separado</option>
          <option>Concluído</option>
          <option>Cancelado</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label mb-1">De</label>
        <input id="dFrom" type="date" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label mb-1">Até</label>
        <input id="dTo" type="date" class="form-control">
      </div>
      <div class="col-12 col-md-3 ms-auto">
        <label class="form-label mb-1 d-block"> </label>
        <button id="btnNova" class="btn btn-primary-clean w-100"><i class="bi bi-plus-lg"></i> Nova Venda</button>
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card-soft p-0">
    <div class="table-responsive" style="max-height:60vh;">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Documento</th>
            <th>Data</th>
            <th>Vendedor</th>
            <th>Status</th>
            <th class="text-end">Subtotal</th>
            <th class="text-end">Desconto</th>
            <th class="text-end">Total</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="empty">Nenhum registro.</div>
    </div>
  </div>
</div>

<!-- Modal Nova Venda -->
<div class="modal fade" id="modalVenda" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 id="modalTitle" class="modal-title">Nova Venda</h5>
      <button class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
    </div>
    <div class="modal-body">
      <form id="formVenda" novalidate>
        <div class="row g-3">
          <div class="col-md-4"><label class="form-label">Nome Cliente</label><input id="iCliente" class="form-control" required></div>
          <div class="col-md-4"><label class="form-label">Tipo Doc.</label>
            <select id="iDocTipo" class="form-select"><option>CPF</option><option>CNPJ</option></select>
          </div>
          <div class="col-md-4"><label class="form-label">CPF/CNPJ</label><input id="iDocumento" class="form-control" placeholder="000.000.000-00"></div>

          <div class="col-md-3"><label class="form-label">Data</label><input id="iData" type="date" class="form-control" required></div>
          <div class="col-md-3"><label class="form-label">Vendedor</label><input id="iVendedor" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Pagamento</label>
            <select id="iPagamento" class="form-select"><option>Dinheiro</option><option>PIX</option><option>Cartão Débito</option><option>Cartão de Crédito</option><option>Outro</option></select>
          </div>
          <div class="col-md-3"><label class="form-label">Status</label>
            <select id="iStatus" class="form-select"><option>Aguardando Pagamento</option><option>Separado</option><option>Concluído</option><option>Cancelado</option></select>
          </div>

          <!-- Itens (estoque) -->
          <div class="col-lg-6 parts-panel">
            <div class="row g-2">
              <div class="col-8"><input id="pSearch" class="form-control" placeholder="Buscar item por SKU, nome..."></div>
              <div class="col-4"><select id="pCategoria" class="form-select"><option value="">Todas as categorias</option></select></div>
              <div class="col-12"><div id="partsList"></div></div>
            </div>
          </div>

          <!-- Carrinho -->
          <div class="col-lg-6">
            <div id="cartList"></div>
            <div class="row g-2 mt-2">
              <div class="col-md-4"><label class="form-label">Desconto</label><input id="iDesconto" type="number" step="0.01" min="0" class="form-control mono" value="0"></div>
              <div class="col-md-8"></div>
              <div class="col-12">
                <div class="totals d-flex justify-content-between mono">
                  <div>Subtotal: <span id="cSubtotal">R$ 0,00</span></div>
                  <div>Total: <strong id="cTotal">R$ 0,00</strong></div>
                </div>
              </div>
              <div class="col-12">
                <div class="d-grid mt-2">
                  <button id="btnSalvar" type="button" class="btn btn-primary-clean btn-lg"><i class="bi bi-check2-circle"></i> Salvar Venda</button>
                </div>
              </div>
            </div>
          </div>
        </div> <!-- row -->
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" data-bs-dismiss="modal">Fechar</button>
    </div>
  </div></div>
</div>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="toastOK" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex"><div class="toast-body">Venda salva com sucesso.</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
  </div>
  <div id="toastERR" class="toast align-items-center text-bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex"><div class="toast-body">Erro ao salvar. Veja o console.</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', ()=>{
  const BRL  = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  const $    = id => document.getElementById(id);
  const money = n => BRL.format(+n||0);
  const todayISO = () => new Date().toISOString().slice(0,10);
  const toast = (id)=> new bootstrap.Toast($(id)).show();

  function storageOK(){
    try{ const k='__v_test__'+Date.now(); localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; }
    catch(e){ console.error('localStorage bloqueado:', e); return false; }
  }
  const canStore = storageOK();
  if(!canStore) $('lsWarn').style.display='block';

  /* ===== ESTOQUE ===== */
  const STOCK_KEYS=["estoque.ui.v2","estoque.clean.color.v1","estoque.clean.v1","estoque.visualclean.v1","estoque"];
  function loadStock(){
    for(const k of STOCK_KEYS){
      try{ const raw=localStorage.getItem(k); if(raw){ const arr=JSON.parse(raw)||[]; return {key:k, items:Array.isArray(arr)?arr:[]}; } }catch(e){}
    }
    return {key:null, items:[]};
  }
  function saveStock(key,items){
    if(!canStore || !key) return;
    try{ localStorage.setItem(key, JSON.stringify(items)); }catch(e){ console.error('Falha ao salvar estoque:', e); }
  }
  let estoque = loadStock();
  estoque.items = (estoque.items||[]).map(it=>({
    sku:String(it.sku??""), nome:String(it.nome??""), categoria:String(it.categoria??""),
    qtd:Number(it.qtd??0), alerta:Number(it.alerta??0),
    preco:Number(it.preco??0), custo:Number(it.custo??0), local:String(it.local??"")
  }));

  /* ===== VENDAS ===== */
  const V_KEY="vendas.orders.v1";
  let vendas=[];
  try{ const arr=JSON.parse(localStorage.getItem(V_KEY)||'[]'); vendas=Array.isArray(arr)?arr:[]; }catch(e){ vendas=[]; }
  const saveVendas=()=>{ if(!canStore) return; try{ localStorage.setItem(V_KEY, JSON.stringify(vendas)); }catch(e){ console.error('Falha ao salvar vendas:', e); } };
  // deixa acessível caso outro script use
  window.vendas = vendas;

  /* ===== UI helpers ===== */
  function esc(s){ return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function statusBadge(s){
    const map={"Aguardando Pagamento":["st-aguardando","bi-hourglass-split"],"Separado":["st-separado","bi-box-seam"],"Concluído":["st-concluido","bi-check-circle"],"Cancelado":["st-cancelado","bi-x-circle"]};
    const [cls,icon]=(map[s]||map["Aguardando Pagamento"]);
    return `<span class="status-badge ${cls}"><i class="bi ${icon}"></i><span>${esc(s||'Aguardando Pagamento')}</span></span>`;
  }
  const inRange=(d,de,ate)=>{ if(!d) return true; if(de&&d<de) return false; if(ate&&d>ate) return false; return true; };

  /* ===== Render ===== */
  function renderMetrics(list){
    const aguard=list.filter(v=>v.status==="Aguardando Pagamento").length;
    const total=list.reduce((s,v)=> s + Math.max(0,(+v.subtotal||0) - (+v.desconto||0)), 0);
    $('mPedidos').textContent=list.length;
    $('mAguardando').textContent=aguard;
    $('mTotal').textContent=money(total);
  }

  function renderTable(){
    const q=($('search').value||'').toLowerCase();
    const fs=$('fStatus').value, de=$('dFrom').value, ate=$('dTo').value;
    const data=vendas.filter(v=>{
      const mQ=!q||[v.cliente,v.vendedor,v.documento,v.docTipo].join(' ').toLowerCase().includes(q);
      const mS=!fs||v.status===fs;
      const mD=inRange(v.data,de,ate);
      return mQ&&mS&&mD;
    });
    renderMetrics(data);
    const tbody=$('tbody'), empty=$('empty');
    if(!data.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
    empty.style.display='none';
    tbody.innerHTML=data.map(v=>{
      const total=Math.max(0,(+v.subtotal||0)-(+v.desconto||0));
      return `<tr>
        <td>${esc(v.cliente||'-')}</td>
        <td>${esc((v.docTipo||'')+': '+(v.documento||'-'))}</td>
        <td>${esc(v.data||'-')}</td>
        <td>${esc(v.vendedor||'-')}</td>
        <td>${statusBadge(v.status)}</td>
        <td class="text-end">${money(+v.subtotal||0)}</td>
        <td class="text-end">${money(+v.desconto||0)}</td>
        <td class="text-end">${money(total)}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-ghost" data-action="print" data-id="${v.id}">Imprimir</button>
          <button class="btn btn-sm btn-ghost" data-action="edit" data-id="${v.id}">Editar</button>
          <button class="btn btn-sm btn-ghost" data-action="del" data-id="${v.id}">Excluir</button>
        </td>
      </tr>`;
    }).join('');
  }

  /* ===== Modal ===== */
  const modal = new bootstrap.Modal(document.getElementById('modalVenda'));
  let editingId=null, cart=[];

  function rebuildPartCats(){
    const sel=$('pCategoria');
    const cats=[...new Set(estoque.items.map(i=>i.categoria).filter(Boolean))].sort();
    sel.innerHTML='<option value="">Todas as categorias</option>'+cats.map(c=>`<option>${esc(c)}</option>`).join('');
  }
  function itemPrice(it){ // fallback custo quando não tiver preço
    const p=+it.preco||0, c=+it.custo||0;
    return p>0? p : c;
  }
  function renderParts(){
    const q=($('pSearch').value||'').toLowerCase(), cat=$('pCategoria').value;
    const reserved=new Map(cart.map(x=>[x.sku,x.qtd]));
    const items=estoque.items.filter(it=>{
      const mQ=!q||[it.sku,it.nome,it.categoria].join(' ').toLowerCase().includes(q);
      const mC=!cat||(it.categoria||'')===cat;
      return mQ&&mC;
    }).slice(0,80);
    $('partsList').innerHTML = items.map(it=>{
      const disp=Math.max(0,(+it.qtd||0)-(reserved.get(it.sku)||0));
      const qid='q_'+String(it.sku).replace(/[^a-z0-9_-]/gi,'_');
      return `<div class="part-card">
        <div class="d-flex justify-content-between">
          <div class="fw-semibold">${esc(it.nome||'-')}</div>
          <span class="badge-soft">SKU ${esc(it.sku||'-')}</span>
        </div>
        <div class="small text-muted">Cat: ${esc(it.categoria||'-')} • Em estoque: ${disp} • Preço: <strong>${money(itemPrice(it))}</strong></div>
        <div class="d-flex gap-2 mt-1">
          <input id="${qid}" type="number" min="1" value="1" class="form-control form-control-sm" style="max-width:90px">
          <button class="btn btn-sm btn-primary-clean" data-action="addPart" data-sku="${encodeURIComponent(it.sku)}" data-qid="${qid}">
            <i class="bi bi-plus-lg"></i> Adicionar
          </button>
        </div>
      </div>`;
    }).join('') || `<div class="text-muted">Nada encontrado…</div>`;
  }

  function renderCart(){
    $('cartList').innerHTML = cart.map((it,i)=>`
      <div class="cart-item d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold">${esc(it.nome)}</div>
          <div class="small text-muted">SKU ${esc(it.sku)} • ${money(it.preco)} • Qtd:
            <input data-action="changeQty" data-idx="${i}" type="number" min="1" value="${it.qtd}" class="form-control form-control-sm d-inline-block ms-1 mono" style="width:80px">
          </div>
        </div>
        <div class="right-num mono">
          ${money(it.qtd*it.preco)}
          <button class="btn btn-sm btn-ghost ms-2" data-action="removePart" data-idx="${i}"><i class="bi bi-x-lg"></i></button>
        </div>
      </div>
    `).join('') || `<div class="text-muted">Carrinho vazio…</div>`;

    const subtotal=cart.reduce((s,x)=>s+x.qtd*x.preco,0);
    $('cSubtotal').textContent=money(subtotal);
    const total=Math.max(0, subtotal-(+$('iDesconto').value||0));
    $('cTotal').textContent=money(total);
  }

  function resetModal(){
    editingId=null; cart=[];
    $('formVenda').reset();
    $('iData').value=todayISO();
    $('iStatus').value='Aguardando Pagamento';
    $('iPagamento').value='Dinheiro';
    $('iDocTipo').value='CPF';
    $('iDocumento').placeholder='000.000.000-00';
    $('iDesconto').value=0;
    estoque = loadStock();
    rebuildPartCats(); renderParts(); renderCart();
  }

  $('iDocTipo').addEventListener('change', ()=>{
    $('iDocumento').placeholder = $('iDocTipo').value==='CNPJ' ? '00.000.000/0001-00' : '000.000.000-00';
  });

  // abrir modal
  $('btnNova').addEventListener('click', ()=>{ $('modalTitle').textContent='Nova Venda'; resetModal(); modal.show(); });

  // filtros
  $('search').addEventListener('input', renderTable);
  $('fStatus').addEventListener('change', renderTable);
  $('dFrom').addEventListener('input', renderTable);
  $('dTo').addEventListener('input', renderTable);

  // peças
  $('pSearch').addEventListener('input', renderParts);
  $('pCategoria').addEventListener('change', renderParts);

  // totais
  $('iDesconto').addEventListener('input', renderCart);

  // lista de peças (delegação)
  $('partsList').addEventListener('click', (ev)=>{
    const btn=ev.target.closest('[data-action="addPart"]'); if(!btn) return;
    const sku=decodeURIComponent(btn.dataset.sku), qid=btn.dataset.qid;
    const it=estoque.items.find(x=>x.sku===sku);
    if(!it){ alert('Item não encontrado no estoque.'); return; }
    let q=Math.max(1, parseInt((document.getElementById(qid)||{}).value||'1',10));
    const reserved=cart.find(x=>x.sku===sku)?.qtd||0;
    const disp=Math.max(0,(+it.qtd||0)-reserved);
    if(q>disp) q=disp;
    if(q<=0){ alert('Sem quantidade disponível.'); return; }
    const i=cart.findIndex(x=>x.sku===sku);
    const preco=itemPrice(it);
    if(i>=0) cart[i].qtd+=q; else cart.push({sku, nome:it.nome, preco:preco, qtd:q});
    renderCart(); renderParts();
  });

  // carrinho
  $('cartList').addEventListener('input', (ev)=>{
    if(ev.target.dataset.action!=='changeQty') return;
    const i=+ev.target.dataset.idx; let q=Math.max(1, parseInt(ev.target.value||'1',10));
    const sku=cart[i].sku, stock=+(estoque.items.find(x=>x.sku===sku)?.qtd||0);
    const others=cart.filter((_,idx)=>idx!==i && _.sku===sku).reduce((s,x)=>s+x.qtd,0);
    const disp=Math.max(0,stock-others);
    if(q>disp) q=disp; cart[i].qtd=q; renderCart(); renderParts();
  });
  $('cartList').addEventListener('click',(ev)=>{
    const btn=ev.target.closest('[data-action="removePart"]'); if(!btn) return;
    cart.splice(+btn.dataset.idx,1); renderCart(); renderParts();
  });

  /* ===== Salvar Venda ===== */
  let saving=false;
  $('btnSalvar').addEventListener('click', ()=>{
    if(saving) return;
    const form=$('formVenda');
    if(!form.reportValidity()){ form.classList.add('was-validated'); return; }
    saving=true; $('btnSalvar').disabled=true;

    const venda={
      id: editingId || String(Date.now()),
      cliente:$('iCliente').value.trim(),
      docTipo:$('iDocTipo').value,
      documento:$('iDocumento').value.trim(),
      data:$('iData').value,
      vendedor:$('iVendedor').value.trim(),
      pagamento:$('iPagamento').value,
      status:$('iStatus').value,
      desconto:+$('iDesconto').value||0,
      itens:cart.map(x=>({sku:x.sku,nome:x.nome,preco:+x.preco||0,qtd:+x.qtd||0})),
      subtotal:cart.reduce((s,x)=>s+x.qtd*x.preco,0)
    };

    try{
      // ajustar estoque (delta entre antes/depois em caso de edição)
      const old=vendas.find(v=>v.id===venda.id);
      const before=new Map((old?.itens||[]).map(p=>[p.sku,p.qtd]));
      const after=new Map(venda.itens.map(p=>[p.sku,p.qtd]));
      const map=new Map(estoque.items.map(it=>[it.sku,it]));
      const skus=new Set([].concat(Array.from(before.keys()), Array.from(after.keys())));
      skus.forEach((sku)=>{
        const delta=(after.get(sku)||0)-(before.get(sku)||0); // >0 consome
        const it=map.get(sku);
        if(it){ it.qtd=(+it.qtd||0)-delta; if(it.qtd<0) it.qtd=0; }
      });
      estoque.items=[...map.values()];
      saveStock(estoque.key, estoque.items);

      if(old){ const i=vendas.findIndex(v=>v.id===venda.id); vendas[i]=venda; }
      else vendas.push(venda);
      saveVendas();
      window.vendas = vendas;

      renderTable();
      modal.hide(); resetModal();
      toast('toastOK');
    }catch(e){
      console.error('Erro ao salvar venda:', e);
      toast('toastERR');
    }finally{
      saving=false; $('btnSalvar').disabled=false;
    }
  });

  /* ===== Ações da tabela ===== */
  $('tbody').addEventListener('click',(ev)=>{
    const btn=ev.target.closest('[data-action]'); if(!btn) return;
    const id=btn.dataset.id, act=btn.dataset.action;

    if(act==='edit'){
      const v=vendas.find(x=>x.id===id); if(!v) return;
      editingId=v.id; $('modalTitle').textContent='Editar Venda';
      $('iCliente').value=v.cliente||''; $('iDocTipo').value=v.docTipo||'CPF';
      $('iDocumento').value=v.documento||''; $('iData').value=v.data||todayISO();
      $('iVendedor').value=v.vendedor||''; $('iPagamento').value=v.pagamento||'Dinheiro';
      $('iStatus').value=v.status||'Aguardando Pagamento'; $('iDesconto').value=+v.desconto||0;
      estoque = loadStock(); rebuildPartCats(); renderParts();
      cart=(v.itens||[]).map(p=>({sku:p.sku,nome:p.nome,preco:+p.preco||0,qtd:+p.qtd||0}));
      renderCart();
      modal.show();
    }

    if(act==='del'){
      if(!confirm('Excluir esta venda?')) return;
      const v=vendas.find(x=>x.id===id); if(!v) return;
      // devolve estoque
      const map=new Map(estoque.items.map(it=>[it.sku,it]));
      (v.itens||[]).forEach(p=>{ const it=map.get(p.sku); if(it){ it.qtd=(+it.qtd||0)+(+p.qtd||0); } });
      estoque.items=[...map.values()]; saveStock(estoque.key, estoque.items);
      vendas=vendas.filter(x=>x.id!==id); saveVendas(); window.vendas=vendas;
      renderTable();
    }

    if(act==='print'){
      const v=vendas.find(x=>x.id===id); if(!v) return;
      printSalesReceiptInline(v);
    }
  });

  /* ===== Impressão de Vendas (robusto, mesma aparência da OS) ===== */
  function buildSalesReceiptInDoc(doc, venda){
    // zera doc e adiciona title em branco (evita cabeçalho do navegador)
    doc.head.innerHTML=''; 
    doc.body.innerHTML='';
    const title=doc.createElement('title'); title.textContent=' '; doc.head.appendChild(title);

    // CSS do recibo 80mm + fonte 14px
    const style=doc.createElement('style');
    style.textContent=`
      @media print { @page { size: 80mm auto; margin:0; } body{ margin:0 !important; } }
      *{box-sizing:border-box}
      body{margin:0;padding:14px;font-size:14px;line-height:1.3;
           font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace}
      .c{text-align:center}.b{font-weight:700}.big{font-size:16px}
      .ln{border-top:1px dashed #999;margin:10px 0}
      table{width:100%;border-collapse:collapse;margin-top:8px}
      th,td{padding:6px 0;border-bottom:1px dotted #ddd}
      td.r{text-align:right}
    `;
    doc.head.appendChild(style);

    const BRLF=new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const add=(tag,txt,cls)=>{const el=doc.createElement(tag); if(cls) el.className=cls; if(txt!=null) el.textContent=txt; doc.body.appendChild(el); return el;};

    // Cabeçalho
    add('div','Rota Motos','c b big');
    add('div','CNPJ 60.469.425/0001-76','c');
    add('div','Comprovante de Venda','c b');
    add('div','', 'ln');

    // Cliente
    add('div','Dados do Cliente','c b');
    add('div','Nome Cliente: '+(venda.cliente||''));
    add('div', (venda.docTipo||'CPF/CNPJ')+': '+(venda.documento||''));
    add('div','', 'ln');

    // Venda
    add('div','Dados da Venda','c b');
    add('div','Data: '+(venda.data||''));
    add('div','Vendedor: '+(venda.vendedor||''));
    if(venda.status) add('div','Status: '+venda.status);
    add('div','', 'ln');

    // Itens
    add('div','Itens','c b');
    const itens=(venda.itens||[]).map(it=>({
      nome: it.nome||'-',
      qtd: +it.qtd||0,
      preco: (isFinite(+it.preco)&&+it.preco>0)? +it.preco : (+it.custo||0)
    }));
    if(itens.length){
      const t=doc.createElement('table'), thead=doc.createElement('thead'), trh=doc.createElement('tr');
      ['Item','Qtde','Preço','Total'].forEach((h,i)=>{const th=doc.createElement('th'); th.textContent=h; if(i>0) th.className='r'; trh.appendChild(th);});
      thead.appendChild(trh); t.appendChild(thead);
      const tb=doc.createElement('tbody');
      itens.forEach(p=>{
        const tr=doc.createElement('tr');
        const td=(tx,cls)=>{const e=doc.createElement('td'); if(cls) e.className=cls; e.textContent=tx; return e;};
        tr.appendChild(td(p.nome));
        tr.appendChild(td(p.qtd,'r'));
        tr.appendChild(td(BRLF.format(p.preco),'r'));
        tr.appendChild(td(BRLF.format(p.preco*p.qtd),'r'));
        tb.appendChild(tr);
      });
      t.appendChild(tb); doc.body.appendChild(t);
    } else {
      add('div','Sem itens.');
    }

    // Totais
    const subtotal=itens.reduce((s,p)=>s+p.preco*p.qtd,0);
    const descontos=+venda.desconto||0;
    const total=Math.max(0, subtotal-descontos);
    add('div','', 'ln');
    add('div','Forma de Pagamento: '+(venda.pagamento||''));

    const row=(l,v,b)=>{const d=doc.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between';
      const a=doc.createElement('div'); a.textContent=l; const c=doc.createElement('div'); c.textContent=BRLF.format(v); if(b) c.className='b';
      d.appendChild(a); d.appendChild(c); doc.body.appendChild(d);
    };
    row('Subtotal:', subtotal, true);
    row('Descontos:', descontos, false);
    row('Valor Total:', total, true);

    add('div','', 'ln');
    add('div','Observações: CONFIRA A EMBALAGEM E ITENS ANTES DE ABRIR OU UTILIZAR OS MESMOS! ROTA MOTOS Agradece!','c');
  }

  function printSalesReceiptInline(venda){
    // Cria o iframe e escreve HTML base — evita timing issues de render
    const iframe=document.createElement('iframe');
    iframe.style.position='fixed';
    iframe.style.right='-9999px';
    iframe.style.bottom='0';
    iframe.width='0';
    iframe.height='0';
    iframe.setAttribute('aria-hidden','true');
    // sandbox sem bloquear same-origin (necessário pro print)
    iframe.setAttribute('sandbox','allow-same-origin allow-modals');
    document.body.appendChild(iframe);

    const win=iframe.contentWindow;
    const doc=win.document;

    // HTML base
    doc.open();
    doc.write('<!doctype html><html><head><meta charset="utf-8"><title> </title></head><body></body></html>');
    doc.close();

    // Constrói recibo via DOM e imprime
    try{ buildSalesReceiptInDoc(doc, venda); }catch(e){ console.error('Falha ao montar recibo:', e); }

    setTimeout(()=>{
      try{
        win.focus();
        win.print();
      }catch(e){
        console.warn('Print bloqueado, tentando fallback...', e);
        try{
          const html = doc.documentElement.outerHTML;
          const blob = new Blob([html], {type:'text/html'});
          const url  = URL.createObjectURL(blob);
          window.open(url, '_blank', 'noopener');
        }catch(e2){ console.error('Fallback falhou:', e2); }
      }
      setTimeout(()=> iframe.remove(), 1200);
    }, 100);
  }

  /* ===== Ações iniciais ===== */
  (function init(){
    const now=new Date(); const y=now.getFullYear(); const m=String(now.getMonth()+1).padStart(2,'0');
    $('dFrom').value=`${y}-${m}-01`; $('dTo').value=todayISO();
    renderTable(); rebuildPartCats(); renderParts();
  })();
});
</script>
</body>
</html>

